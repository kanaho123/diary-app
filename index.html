<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šæ—¥ã®æ—¥è¨˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
            color: #333;
            padding-bottom: 80px;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .login-box h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }

        .login-box p {
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.8;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
            background: #fafbff;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .login-tab {
            flex: 1;
            padding: 10px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .login-tab.active {
            background: #667eea;
            color: white;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        /* ç®¡ç†è€…ãƒ‘ãƒãƒ« */
        .admin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            overflow-y: auto;
        }

        .admin-overlay.show {
            display: flex;
        }

        .admin-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .admin-header h2 {
            font-size: 24px;
            color: #333;
        }

        .admin-close-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-search {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .admin-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .admin-diary-item {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .admin-diary-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .admin-diary-info {
            font-size: 13px;
            color: #666;
        }

        .admin-diary-content {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
        }

        .admin-diary-field {
            margin-bottom: 8px;
        }

        .admin-diary-label {
            font-weight: 600;
            color: #667eea;
            margin-right: 5px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: white;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            user-select: none;
        }

        .header p {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
        }

        .header-user {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 600px;
            margin: 10px auto 0;
        }

        .user-info {
            font-size: 13px;
            color: #667eea;
            font-weight: 500;
        }

        .logout-btn {
            background: none;
            border: 1px solid #e0e0e0;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #f5f5f5;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav {
            background: white;
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 120px;
            z-index: 99;
        }

        .nav-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 15px;
            cursor: pointer;
            color: #888;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .nav-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* è³ªå•ã‚«ãƒ¼ãƒ‰ */
        .question-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .question-label {
            display: block;
            font-size: 15px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .required-badge {
            display: inline-block;
            background: #ff6b6b;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .optional-badge {
            display: inline-block;
            background: #e0e0e0;
            color: #666;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        textarea, input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            transition: all 0.3s;
        }

        input[type="text"], input[type="password"] {
            min-height: auto;
        }

        textarea:focus, input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            background: #fafbff;
        }

        /* æ°—åˆ†ã‚¿ã‚° */
        .mood-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .mood-tag {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mood-tag:hover {
            background: #e8ecff;
        }

        .mood-tag.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* æŠ˜ã‚ŠãŸãŸã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .collapsible-section {
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section-header {
            padding: 18px 20px;
            background: #fafafa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .section-header:active {
            background: #f0f0f0;
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }

        .section-subtitle {
            font-size: 13px;
            color: #888;
            margin-top: 3px;
        }

        .section-arrow {
            font-size: 20px;
            color: #888;
            transition: transform 0.3s;
        }

        .section-header.expanded .section-arrow {
            transform: rotate(180deg);
        }

        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .section-content.expanded {
            max-height: 5000px;
        }

        .section-inner {
            padding: 20px;
        }

        /* å€‹åˆ¥è³ªå•ã®æŠ˜ã‚ŠãŸãŸã¿ */
        .question-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 15px 0;
        }

        .question-item:last-child {
            border-bottom: none;
        }

        .question-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 5px 0;
        }

        .question-text {
            font-size: 14px;
            color: #555;
            flex: 1;
        }

        .favorite-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            margin-right: 10px;
        }

        .question-arrow {
            font-size: 18px;
            color: #ccc;
            transition: transform 0.3s;
        }

        .question-toggle.expanded .question-arrow {
            transform: rotate(180deg);
        }

        .question-input-area {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .question-input-area.expanded {
            max-height: 500px;
            margin-top: 10px;
        }

        /* å…¬é–‹è¨­å®š */
        .privacy-controls {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            font-size: 13px;
        }

        .privacy-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .privacy-checkbox input[type="checkbox"] {
            width: auto;
            height: auto;
            min-height: auto;
            cursor: pointer;
        }

        .privacy-checkbox label {
            cursor: pointer;
            color: #666;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .save-btn-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ */
        .feed-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .feed-author {
            font-size: 14px;
            color: #888;
        }

        .feed-date {
            font-size: 13px;
            color: #aaa;
        }

        .feed-content {
            margin-bottom: 15px;
        }

        .feed-question {
            margin-bottom: 12px;
        }

        .feed-question-title {
            font-size: 13px;
            color: #888;
            margin-bottom: 5px;
        }

        .feed-question-answer {
            font-size: 15px;
            color: #333;
            line-height: 1.6;
        }

        .feed-reactions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .reaction-btn {
            padding: 8px 14px;
            background: #f5f5f5;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .reaction-btn:hover {
            background: #e8ecff;
        }

        .reaction-btn.sent {
            background: #667eea;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 15px;
            line-height: 1.8;
        }

        /* ãƒ©ãƒ³ãƒ€ãƒ è³ªå•ã‚«ãƒ¼ãƒ‰ */
        .random-question-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e8e8e8;
        }

        .random-question-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .random-question-title {
            font-size: 14px;
            font-weight: 500;
            color: #666;
        }

        .random-question-text-display {
            font-size: 15px;
            color: #333;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        /* ãŠæ°—ã«å…¥ã‚Šè³ªå• */
        .favorite-questions {
            background: #fffbf0;
            border: 2px solid #ffe4a3;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .favorite-title {
            font-size: 15px;
            font-weight: 600;
            color: #d4a500;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .success-message.show {
            display: flex;
        }

        /* è‡ªåˆ†ã®æ—¥è¨˜ä¸€è¦§ */
        .my-diary-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .my-diary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .my-diary-date {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }

        .my-diary-mood {
            font-size: 13px;
            color: #888;
        }

        .my-diary-content {
            margin-bottom: 10px;
        }

        .my-diary-question {
            margin-bottom: 10px;
        }

        .my-diary-question-title {
            font-size: 12px;
            color: #999;
            margin-bottom: 3px;
        }

        .my-diary-question-answer {
            font-size: 14px;
            color: #555;
            line-height: 1.5;
        }

        .delete-diary-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .delete-diary-btn:hover {
            background: #ff5252;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .question-card, .collapsible-section {
                border-radius: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h1>ğŸ“– ä»Šæ—¥ã®æ—¥è¨˜ã¸ã‚ˆã†ã“ã</h1>
            <p>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨PINã§<br>ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯æ–°è¦ç™»éŒ²ã—ã¦ãã ã•ã„</p>
            
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchLoginTab('login')">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button class="login-tab" onclick="switchLoginTab('register')">æ–°è¦ç™»éŒ²</button>
            </div>

            <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="loginForm" class="login-form active">
                <input type="text" class="login-input" id="loginNickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " maxlength="20">
                <input type="password" class="login-input" id="loginPin" placeholder="4æ¡PIN" maxlength="4" pattern="[0-9]{4}">
                <button class="login-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>

            <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="registerForm" class="login-form">
                <input type="text" class="login-input" id="registerNickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " maxlength="20">
                <input type="password" class="login-input" id="registerPin" placeholder="4æ¡PINï¼ˆæ•°å­—ã®ã¿ï¼‰" maxlength="4" pattern="[0-9]{4}">
                <input type="password" class="login-input" id="registerPinConfirm" placeholder="PINç¢ºèª" maxlength="4" pattern="[0-9]{4}">
                <button class="login-btn" onclick="register()">ç™»éŒ²</button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†è€…ãƒ‘ãƒãƒ« -->
    <div class="admin-overlay" id="adminOverlay">
        <div class="admin-panel">
            <div class="admin-header">
                <h2>ğŸ” ç®¡ç†è€…ãƒ‘ãƒãƒ«</h2>
                <button class="admin-close-btn" onclick="closeAdminPanel()">é–‰ã˜ã‚‹</button>
            </div>

            <div class="admin-controls">
                <input type="text" class="admin-search" id="adminSearchNickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§æ¤œç´¢" onkeyup="filterAdminDiaries()">
                <input type="date" class="admin-search" id="adminSearchDate" onchange="filterAdminDiaries()">
                <button class="admin-btn" onclick="exportCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>
            </div>

            <div id="adminDiariesContent"></div>
        </div>
    </div>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <h1 id="headerTitle" onclick="handleTitleTap()">ğŸ“– ä»Šæ—¥ã®æ—¥è¨˜</h1>
        <p id="headerSubtitle">ä»Šæ—¥ã‚‚ãŠã¤ã‹ã‚Œã•ã¾ã§ã™</p>
        <div class="header-user">
            <span class="user-info" id="userInfo"></span>
            <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="nav">
        <button class="nav-btn active" onclick="switchPage('write')">æ›¸ã</button>
        <button class="nav-btn" onclick="switchPage('my')" id="myNavBtn">è‡ªåˆ†ã®æ—¥è¨˜</button>
        <button class="nav-btn" onclick="switchPage('feed')" id="feedNavBtn">ã¿ã‚“ãªã®æ—¥è¨˜</button>
    </div>

    <!-- ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="container">
        <!-- æ›¸ããƒšãƒ¼ã‚¸ -->
        <div id="writePage" class="page active">
            <!-- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="success-message" id="successMessage">
                <span>âœ…</span>
                <span id="successMessageText">æ—¥è¨˜ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼</span>
            </div>

            <!-- å¿…é ˆè³ªå• -->
            <div class="question-card">
                <label class="question-label">
                    Q1: ä»Šã®æ°—åˆ†ã¯ï¼Ÿ<span class="required-badge">å¿…é ˆ</span>
                </label>
                <input type="text" id="mood" placeholder="ä¸€è¨€ã§è¡¨ã™ã¨..." />
                <div class="mood-tags">
                    <div class="mood-tag" onclick="selectMood(this, 'ğŸ˜Š ã‚ˆã„')">ğŸ˜Š ã‚ˆã„</div>
                    <div class="mood-tag" onclick="selectMood(this, 'ğŸ˜Œ ã¾ã‚ã¾ã‚')">ğŸ˜Œ ã¾ã‚ã¾ã‚</div>
                    <div class="mood-tag" onclick="selectMood(this, 'ğŸ˜ ãµã¤ã†')">ğŸ˜ ãµã¤ã†</div>
                    <div class="mood-tag" onclick="selectMood(this, 'ğŸ˜” ã—ã‚“ã©ã„')">ğŸ˜” ã—ã‚“ã©ã„</div>
                    <div class="mood-tag" onclick="selectMood(this, 'ğŸ˜¤ ãƒ¢ãƒ¤ãƒ¢ãƒ¤')">ğŸ˜¤ ãƒ¢ãƒ¤ãƒ¢ãƒ¤</div>
                    <div class="mood-tag" onclick="selectMood(this, 'ğŸ¤” ã‚ˆãã‚ã‹ã‚‰ã‚“')">ğŸ¤” ã‚ˆãã‚ã‹ã‚‰ã‚“</div>
                </div>
            </div>

            <div class="question-card">
                <label class="question-label">
                    Q2: ä»Šæ—¥ã„ã¡ã°ã‚“æ®‹ã—ãŸã„ã“ã¨ã¯ï¼Ÿ<span class="required-badge">å¿…é ˆ</span>
                </label>
                <textarea id="memorable" placeholder="è‰¯ã„ã“ã¨ã€æ‚ªã„ã“ã¨ã€ã©ã†ã§ã‚‚ã„ã„ã“ã¨ã€ãªã‚“ã§ã‚‚OK"></textarea>
            </div>

            <div class="question-card">
                <label class="question-label">
                    Q3: ä»Šæ—¥ã®è‡ªåˆ†ã«ä¸€è¨€<span class="required-badge">å¿…é ˆ</span>
                </label>
                <textarea id="selfTalk" placeholder="è¤’ã‚ã€ã­ãã‚‰ã„ã€ãƒ„ãƒƒã‚³ãƒŸã€ãªã‚“ã§ã‚‚OK"></textarea>
            </div>

            <!-- ãŠæ°—ã«å…¥ã‚Šè³ªå• -->
            <div class="favorite-questions" id="favoriteSection" style="display: none;">
                <div class="favorite-title">â­ ã‚ˆãæ›¸ãè³ªå•</div>
                <div id="favoriteQuestionsList"></div>
            </div>

            <!-- ãƒ©ãƒ³ãƒ€ãƒ è³ªå• -->
            <div class="random-question-card">
                <div class="random-question-header">
                    <span class="random-question-title">ğŸ“‹ æ¯æ—¥ãƒ©ãƒ³ãƒ€ãƒ è³ªå•</span>
                    <span class="optional-badge">ä»»æ„</span>
                </div>
                <div class="random-question-text-display" id="randomQuestionText"></div>
                <textarea id="randomAnswer" placeholder="ç­”ãˆã¦ã¿ã‚‹ï¼ˆä»»æ„ï¼‰"></textarea>
                <div class="privacy-controls">
                    <div class="privacy-checkbox">
                        <input type="checkbox" id="randomPublic">
                        <label for="randomPublic">å…¬é–‹ã™ã‚‹</label>
                    </div>
                    <div class="privacy-checkbox">
                        <input type="checkbox" id="randomAnonymous">
                        <label for="randomAnonymous">åŒ¿åã§å…¬é–‹</label>
                    </div>
                </div>
            </div>

            <!-- ä»»æ„è³ªå•ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ï¼‰ -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div>
                        <div class="section-title">ã•ã£ã¨æ›¸ããŸã„äººã ã‘</div>
                        <div class="section-subtitle">æ°—è»½ã«æ›¸ã‘ã‚‹è³ªå•ãŸã¡</div>
                    </div>
                    <span class="section-arrow">â–¼</span>
                </div>
                <div class="section-content">
                    <div class="section-inner" id="quickQuestions"></div>
                </div>
            </div>

            <!-- ä»»æ„è³ªå•ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ—ï¼‰ -->
            <div class="collapsible-section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div>
                        <div class="section-title">ã¡ã‚‡ã£ã¨è€ƒãˆãŸã„äººã ã‘</div>
                        <div class="section-subtitle">å†…é¢ã«è§¦ã‚Œã‚‹è³ªå•ãŸã¡</div>
                    </div>
                    <span class="section-arrow">â–¼</span>
                </div>
                <div class="section-content">
                    <div class="section-inner" id="deepQuestions"></div>
                </div>
            </div>
        </div>

        <!-- è‡ªåˆ†ã®æ—¥è¨˜ãƒšãƒ¼ã‚¸ -->
        <div id="myPage" class="page">
            <div id="myDiariesContent"></div>
        </div>

        <!-- ã¿ã‚“ãªã®æ—¥è¨˜ãƒšãƒ¼ã‚¸ -->
        <div id="feedPage" class="page">
            <div id="feedContent"></div>
        </div>
    </div>

    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <div class="save-btn-container">
        <button class="btn btn-primary" id="saveBtn" onclick="saveDiary()">ğŸ“ ä¿å­˜ã™ã‚‹</button>
    </div>

    <script>
        // ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®é‹ç”¨ã§ã¯ç’°å¢ƒå¤‰æ•°ãªã©ã§ç®¡ç†ï¼‰
        const ADMIN_CODE = "1234";

        // ãƒ‡ãƒ¼ã‚¿å®šç¾©
        const quickQuestions = [
            "ä»Šæ—¥ã® happy",
            "ä»Šæ—¥ã®è‡ªåˆ†ã‚’è¤’ã‚ãŸã„ã¨ã“ã‚",
            "ä»Šæ—¥ã®ã‚„ã£ã¡ã¾ã£ãŸã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰",
            "ä»Šæ—¥ä½•é£Ÿã¹ãŸï¼Ÿ",
            "ä»Šæ—¥ã€ã‚ã‚ŠãŒã¨ã†ã‚’ä¼ãˆãŸã„ã“ã¨",
            "ä»Šæ—¥ã®æœè£…ã‚’ä¸€è¨€ã§è¨€ã†ã¨ï¼Ÿ",
            "ä»Šæ—¥ã®ä½“èª¿ãƒ»ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³",
            "ã¿ã‚“ãªã«ã‚·ã‚§ã‚¢ã—ãŸã„ã“ã¨",
            "æ˜æ—¥æ¥½ã—ã¿ã«ã—ã¦ã‚‹ã“ã¨",
            "æ˜æ—¥ã‚„ã‚ŠãŸã„äº‹"
        ];

        const deepQuestions = [
            "ä»Šæ—¥ã€ã„ã¡ã°ã‚“æ°—æŒã¡ãŒæºã‚ŒãŸã“ã¨ã¯ï¼Ÿ",
            "ä»Šæ—¥ã€å®‰å¿ƒã—ãŸç¬é–“ã¯ï¼Ÿ",
            "ä»Šæ—¥ã€ã¡ã‚‡ã£ã¨ç„¡ç†ã—ã¦ãŸã‹ã‚‚ã¨æ€ã†ç¬é–“ã‚ã£ãŸï¼Ÿ",
            "ä»Šæ—¥ã€æ­£ç›´ã‚ã‚“ã©ãã•ã‹ã£ãŸã“ã¨",
            "ä»Šæ—¥ã€ã‚„ã‚‰ãªãã¦ã‚ˆã‹ã£ãŸã¨æ€ã†ã“ã¨",
            "ä»Šæ—¥ã€ãªã‚“ã¨ãªãå¼•ã£ã‹ã‹ã£ã¦ã‚‹ã“ã¨",
            "ãã®å¼•ã£ã‹ã‹ã‚Šã¯ã€ä½•ãŒå¤§äº‹ã ã‹ã‚‰ã ã¨æ€ã†ï¼Ÿ",
            "ã‚‚ã—å‹ã ã¡ãŒåŒã˜1æ—¥ã‚’éã”ã—ã¦ãŸã‚‰ã€ãªã‚“ã¦å£°ã‹ã‘ã‚‹ï¼Ÿ",
            "æ˜æ—¥ã©ã†ãªã£ãŸã‚‰ã¾ã‚okï¼Ÿ",
            "ä»Šæ—¥ã®è‡ªåˆ†ã«ã¨ã£ã¦ã€ã„ã¡ã°ã‚“å®ˆã‚ŠãŸã‹ã£ãŸã‚‚ã®ã¯ï¼Ÿ"
        ];

        const randomQuestionPool = [
            "ä»Šæ—¥ã‚’ä¸€è¨€ã§ã‚¿ã‚¤ãƒˆãƒ«ã«ã™ã‚‹ã¨ï¼Ÿ",
            "ä»Šæ—¥ã®BGMã¯ï¼Ÿ",
            "ä»Šæ—¥ã‚’è‰²ã§è¡¨ã™ã¨ï¼Ÿ",
            "ä»Šæ—¥ã„ã¡ã°ã‚“äººé–“ã£ã½ã‹ã£ãŸç¬é–“ã¯ï¼Ÿ",
            "ä»Šæ—¥ã®ã€Œã¾ã‚ã„ã£ã‹ã€ã¯ã©ã‚Œï¼Ÿ",
            "ä»Šæ—¥ã®LOVEã¯ï¼Ÿ",
            "ä»Šæ—¥ã„ã¡ã°ã‚“ç¬‘ã£ãŸã“ã¨",
            "ä»Šæ—¥ã®å°ã•ãªç™ºè¦‹",
            "ä»Šæ—¥ã®è‡ªåˆ†ã‚’å‹•ç‰©ã«ä¾‹ãˆã‚‹ã¨ï¼Ÿ"
        ];

        // çŠ¶æ…‹ç®¡ç†
        let currentPage = 'write';
        let currentNickname = '';
        let currentPin = '';
        let favorites = [];
        let diaries = [];
        let todayDiary = null;
        let isEditMode = false;
        let titleTapCount = 0;
        let titleTapTimer = null;

        // åˆæœŸåŒ–
        window.onload = function() {
            checkLogin();
        };

        // JST(æ—¥æœ¬æ™‚é–“)ã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾— (YYYY-MM-DD)
        function getTodayJST() {
            const now = new Date();
            const jstOffset = 9 * 60;
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const jstTime = new Date(utc + (jstOffset * 60000));
            
            const year = jstTime.getFullYear();
            const month = String(jstTime.getMonth() + 1).padStart(2, '0');
            const day = String(jstTime.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // ãƒ­ã‚°ã‚¤ãƒ³ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.login-tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelectorAll('.login-tab')[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
        function checkLogin() {
            const savedAuth = localStorage.getItem('userAuth');
            if (savedAuth) {
                const auth = JSON.parse(savedAuth);
                currentNickname = auth.nickname;
                currentPin = auth.pin;
                initApp();
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
            }
        }

        // æ–°è¦ç™»éŒ²
        function register() {
            const nickname = document.getElementById('registerNickname').value.trim();
            const pin = document.getElementById('registerPin').value.trim();
            const pinConfirm = document.getElementById('registerPinConfirm').value.trim();

            if (!nickname) {
                alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!/^\d{4}$/.test(pin)) {
                alert('4æ¡ã®æ•°å­—ã§PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (pin !== pinConfirm) {
                alert('PINãŒä¸€è‡´ã—ã¾ã›ã‚“');
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[nickname]) {
                alert('ã“ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }

            users[nickname] = { pin: pin };
            localStorage.setItem('users', JSON.stringify(users));

            // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜
            currentNickname = nickname;
            currentPin = pin;
            localStorage.setItem('userAuth', JSON.stringify({ nickname, pin }));

            document.getElementById('loginOverlay').classList.add('hidden');
            initApp();
        }

        // ãƒ­ã‚°ã‚¤ãƒ³
        function login() {
            const nickname = document.getElementById('loginNickname').value.trim();
            const pin = document.getElementById('loginPin').value.trim();

            if (!nickname || !pin) {
                alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (!users[nickname]) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            if (users[nickname].pin !== pin) {
                alert('PINãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            currentNickname = nickname;
            currentPin = pin;
            localStorage.setItem('userAuth', JSON.stringify({ nickname, pin }));

            document.getElementById('loginOverlay').classList.add('hidden');
            initApp();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('userAuth');
                location.reload();
            }
        }

        // ã‚¿ã‚¤ãƒˆãƒ«ã‚¿ãƒƒãƒ—ã§ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ7å›ã§ç®¡ç†è€…ãƒ‘ãƒãƒ«ï¼‰
        function handleTitleTap() {
            titleTapCount++;
            
            if (titleTapTimer) {
                clearTimeout(titleTapTimer);
            }

            if (titleTapCount >= 7) {
                titleTapCount = 0;
                openAdminPanel();
                return;
            }

            titleTapTimer = setTimeout(() => {
                titleTapCount = 0;
            }, 2000);
        }

        // ç®¡ç†è€…ãƒ‘ãƒãƒ«ã‚’é–‹ã
        function openAdminPanel() {
            const code = prompt('ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (code === ADMIN_CODE) {
                document.getElementById('adminOverlay').classList.add('show');
                renderAdminDiaries();
            } else if (code !== null) {
                alert('ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
            }
        }

        // ç®¡ç†è€…ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        function closeAdminPanel() {
            document.getElementById('adminOverlay').classList.remove('show');
        }

        // ç®¡ç†è€…ãƒ‘ãƒãƒ«ã®æ—¥è¨˜ä¸€è¦§
        function renderAdminDiaries() {
            const content = document.getElementById('adminDiariesContent');
            
            if (diaries.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-text">æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
                return;
            }

            const sortedDiaries = [...diaries].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            content.innerHTML = sortedDiaries.map(diary => {
                let contentHtml = '';
                
                contentHtml += `<div class="admin-diary-field"><span class="admin-diary-label">æ°—åˆ†:</span>${escapeHtml(diary.mood)}</div>`;
                contentHtml += `<div class="admin-diary-field"><span class="admin-diary-label">æ®‹ã—ãŸã„ã“ã¨:</span>${escapeHtml(diary.memorable)}</div>`;
                contentHtml += `<div class="admin-diary-field"><span class="admin-diary-label">è‡ªåˆ†ã«ä¸€è¨€:</span>${escapeHtml(diary.selfTalk)}</div>`;
                
                if (diary.randomAnswer) {
                    contentHtml += `<div class="admin-diary-field"><span class="admin-diary-label">${escapeHtml(diary.randomQuestion)}:</span>${escapeHtml(diary.randomAnswer)}</div>`;
                }

                if (diary.optionalAnswers && diary.optionalAnswers.length > 0) {
                    diary.optionalAnswers.forEach(item => {
                        contentHtml += `<div class="admin-diary-field"><span class="admin-diary-label">${escapeHtml(item.question)}:</span>${escapeHtml(item.answer)}</div>`;
                    });
                }

                return `
                    <div class="admin-diary-item" data-nickname="${escapeHtml(diary.nickname)}" data-date="${diary.postDate}">
                        <div class="admin-diary-header">
                            <div>
                                <div class="admin-diary-info"><strong>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</strong> ${escapeHtml(diary.nickname)}</div>
                                <div class="admin-diary-info"><strong>æŠ•ç¨¿æ—¥:</strong> ${diary.postDate} ${formatFullDate(diary.date)}</div>
                            </div>
                            <div class="admin-diary-info">ID: ${diary.id}</div>
                        </div>
                        <div class="admin-diary-content">
                            ${contentHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç®¡ç†è€…ãƒ‘ãƒãƒ«ã®æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterAdminDiaries() {
            const nicknameFilter = document.getElementById('adminSearchNickname').value.toLowerCase();
            const dateFilter = document.getElementById('adminSearchDate').value;

            document.querySelectorAll('.admin-diary-item').forEach(item => {
                const nickname = item.dataset.nickname.toLowerCase();
                const date = item.dataset.date;

                const nicknameMatch = !nicknameFilter || nickname.includes(nicknameFilter);
                const dateMatch = !dateFilter || date === dateFilter;

                item.style.display = (nicknameMatch && dateMatch) ? 'block' : 'none';
            });
        }

        // CSVå‡ºåŠ›
        function exportCSV() {
            if (diaries.length === 0) {
                alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            let csv = 'ID,ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ,æŠ•ç¨¿æ—¥,æ—¥æ™‚,æ°—åˆ†,æ®‹ã—ãŸã„ã“ã¨,è‡ªåˆ†ã«ä¸€è¨€,ãƒ©ãƒ³ãƒ€ãƒ è³ªå•,ãƒ©ãƒ³ãƒ€ãƒ å›ç­”\n';

            diaries.forEach(diary => {
                const row = [
                    diary.id,
                    diary.nickname,
                    diary.postDate,
                    diary.date,
                    diary.mood,
                    diary.memorable.replace(/"/g, '""'),
                    diary.selfTalk.replace(/"/g, '""'),
                    diary.randomQuestion ? diary.randomQuestion.replace(/"/g, '""') : '',
                    diary.randomAnswer ? diary.randomAnswer.replace(/"/g, '""') : ''
                ];

                csv += row.map(field => `"${field}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `diaries_${getTodayJST()}.csv`;
            link.click();
        }

        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        function initApp() {
            document.getElementById('userInfo').textContent = `ğŸ‘¤ ${currentNickname}`;
            loadUserData();
            renderQuestions();
            setRandomQuestion();
            updateFavoriteSection();
            checkTodayDiary();
            updateFeedButton();
            loadTodayDiaryToForm();
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadUserData() {
            favorites = JSON.parse(localStorage.getItem(`favorites_${currentNickname}`) || '[]');
            diaries = JSON.parse(localStorage.getItem('diaries') || '[]');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveUserData() {
            localStorage.setItem(`favorites_${currentNickname}`, JSON.stringify(favorites));
            localStorage.setItem('diaries', JSON.stringify(diaries));
        }

        // ä»Šæ—¥ã®æ—¥è¨˜ãŒã‚ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ ã«å¾©å…ƒ
        function loadTodayDiaryToForm() {
            if (!todayDiary) {
                isEditMode = false;
                document.getElementById('saveBtn').textContent = 'ğŸ“ ä¿å­˜ã™ã‚‹';
                return;
            }

            isEditMode = true;
            document.getElementById('saveBtn').textContent = 'ğŸ”„ æ›´æ–°ã™ã‚‹';

            document.getElementById('mood').value = todayDiary.mood || '';
            document.getElementById('memorable').value = todayDiary.memorable || '';
            document.getElementById('selfTalk').value = todayDiary.selfTalk || '';
            
            document.querySelectorAll('.mood-tag').forEach(tag => {
                tag.classList.remove('selected');
                if (tag.textContent === todayDiary.mood) {
                    tag.classList.add('selected');
                }
            });

            if (todayDiary.randomAnswer) {
                document.getElementById('randomAnswer').value = todayDiary.randomAnswer;
                document.getElementById('randomPublic').checked = todayDiary.randomPublic || false;
                document.getElementById('randomAnonymous').checked = todayDiary.randomAnonymous || false;
            }

            if (todayDiary.optionalAnswers && todayDiary.optionalAnswers.length > 0) {
                todayDiary.optionalAnswers.forEach(item => {
                    const textarea = document.getElementById(item.id);
                    const publicCheckbox = document.getElementById(`${item.id}_public`);
                    const anonymousCheckbox = document.getElementById(`${item.id}_anonymous`);
                    
                    if (textarea) {
                        textarea.value = item.answer;
                        if (publicCheckbox) publicCheckbox.checked = item.isPublic || false;
                        if (anonymousCheckbox) anonymousCheckbox.checked = item.isAnonymous || false;
                        
                        const questionToggle = textarea.closest('.question-item').querySelector('.question-toggle');
                        const inputArea = textarea.closest('.question-input-area');
                        if (questionToggle && inputArea) {
                            questionToggle.classList.add('expanded');
                            inputArea.classList.add('expanded');
                        }
                    }
                });
            }
        }

        // è³ªå•ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆå…¬é–‹è¨­å®šä»˜ãï¼‰
        function renderQuestions() {
            renderQuestionList('quickQuestions', quickQuestions, 'quick');
            renderQuestionList('deepQuestions', deepQuestions, 'deep');
        }

        function renderQuestionList(containerId, questions, category) {
            const container = document.getElementById(containerId);
            container.innerHTML = questions.map((q, index) => {
                const isFavorite = favorites.some(f => f.question === q && f.category === category);
                const questionId = `${category}_${index}`;
                return `
                    <div class="question-item">
                        <div class="question-toggle" onclick="toggleQuestionItem(this)">
                            <button class="favorite-btn" onclick="event.stopPropagation(); toggleFavorite('${escapeHtml(q)}', '${category}', this)">
                                ${isFavorite ? 'â­' : 'â˜†'}
                            </button>
                            <span class="question-text">${escapeHtml(q)}</span>
                            <span class="question-arrow">â–¼</span>
                        </div>
                        <div class="question-input-area">
                            <textarea id="${questionId}" data-question="${escapeHtml(q)}" placeholder="è‡ªç”±ã«æ›¸ã„ã¦ã¿ã¦ãã ã•ã„"></textarea>
                            <div class="privacy-controls">
                                <div class="privacy-checkbox">
                                    <input type="checkbox" id="${questionId}_public">
                                    <label for="${questionId}_public">å…¬é–‹ã™ã‚‹</label>
                                </div>
                                <div class="privacy-checkbox">
                                    <input type="checkbox" id="${questionId}_anonymous">
                                    <label for="${questionId}_anonymous">åŒ¿åã§å…¬é–‹</label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ãƒ©ãƒ³ãƒ€ãƒ è³ªå•ã®è¨­å®š
        function setRandomQuestion() {
            const today = new Date().toDateString();
            let savedQuestion = localStorage.getItem('todayRandomQuestion');
            let savedDate = localStorage.getItem('todayRandomQuestionDate');

            if (savedDate !== today) {
                const randomIndex = Math.floor(Math.random() * randomQuestionPool.length);
                savedQuestion = randomQuestionPool[randomIndex];
                localStorage.setItem('todayRandomQuestion', savedQuestion);
                localStorage.setItem('todayRandomQuestionDate', today);
            }

            document.getElementById('randomQuestionText').textContent = savedQuestion;
        }

        // ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½
        function toggleFavorite(question, category, buttonElement) {
            const existingIndex = favorites.findIndex(f => f.question === question && f.category === category);
            
            if (existingIndex >= 0) {
                favorites.splice(existingIndex, 1);
            } else {
                if (favorites.length >= 5) {
                    alert('ãŠæ°—ã«å…¥ã‚Šã¯æœ€å¤§5å€‹ã¾ã§ã§ã™');
                    return;
                }
                favorites.push({ question, category });
            }
            
            saveUserData();
            renderQuestions();
            updateFavoriteSection();
        }

        function updateFavoriteSection() {
            const section = document.getElementById('favoriteSection');
            const list = document.getElementById('favoriteQuestionsList');
            
            if (favorites.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = favorites.map((fav, index) => {
                const questionId = `fav_${index}`;
                return `
                    <div class="question-item">
                        <div class="question-toggle" onclick="toggleQuestionItem(this)">
                            <span class="question-text">${escapeHtml(fav.question)}</span>
                            <span class="question-arrow">â–¼</span>
                        </div>
                        <div class="question-input-area">
                            <textarea id="${questionId}" data-question="${escapeHtml(fav.question)}" placeholder="è‡ªç”±ã«æ›¸ã„ã¦ã¿ã¦ãã ã•ã„"></textarea>
                            <div class="privacy-controls">
                                <div class="privacy-checkbox">
                                    <input type="checkbox" id="${questionId}_public">
                                    <label for="${questionId}_public">å…¬é–‹ã™ã‚‹</label>
                                </div>
                                <div class="privacy-checkbox">
                                    <input type="checkbox" id="${questionId}_anonymous">
                                    <label for="${questionId}_anonymous">åŒ¿åã§å…¬é–‹</label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹é–‰
        function toggleSection(header) {
            header.classList.toggle('expanded');
            const content = header.nextElementSibling;
            content.classList.toggle('expanded');
        }

        // å€‹åˆ¥è³ªå•ã®é–‹é–‰
        function toggleQuestionItem(toggleElement) {
            toggleElement.classList.toggle('expanded');
            const inputArea = toggleElement.nextElementSibling;
            inputArea.classList.toggle('expanded');
        }

        // æ°—åˆ†é¸æŠ
        function selectMood(element, mood) {
            document.querySelectorAll('.mood-tag').forEach(tag => {
                tag.classList.remove('selected');
            });
            element.classList.add('selected');
            document.getElementById('mood').value = mood;
        }

        // ä»»æ„è³ªå•ã®å›ç­”ã‚’åé›†ï¼ˆå…¬é–‹è¨­å®šå«ã‚€ï¼‰
        function collectOptionalAnswers() {
            const answers = [];
            const allTextareas = document.querySelectorAll('textarea[data-question]');
            
            allTextareas.forEach(textarea => {
                const answer = textarea.value.trim();
                if (answer) {
                    const id = textarea.id;
                    const publicCheckbox = document.getElementById(`${id}_public`);
                    const anonymousCheckbox = document.getElementById(`${id}_anonymous`);
                    
                    answers.push({
                        id: id,
                        question: textarea.getAttribute('data-question'),
                        answer: answer,
                        isPublic: publicCheckbox ? publicCheckbox.checked : false,
                        isAnonymous: anonymousCheckbox ? anonymousCheckbox.checked : false
                    });
                }
            });
            
            return answers;
        }

        // æ—¥è¨˜ä¿å­˜
        function saveDiary() {
            const mood = document.getElementById('mood').value;
            const memorable = document.getElementById('memorable').value;
            const selfTalk = document.getElementById('selfTalk').value;

            if (!mood || !memorable || !selfTalk) {
                alert('å¿…é ˆé …ç›®ï¼ˆæ°—åˆ†ãƒ»æ®‹ã—ãŸã„ã“ã¨ãƒ»è‡ªåˆ†ã«ä¸€è¨€ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const optionalAnswers = collectOptionalAnswers();
            const todayDate = getTodayJST();

            const diary = {
                id: isEditMode ? todayDiary.id : Date.now(),
                date: new Date().toISOString(),
                postDate: todayDate,
                nickname: currentNickname,
                mood,
                memorable,
                selfTalk,
                randomQuestion: document.getElementById('randomQuestionText').textContent,
                randomAnswer: document.getElementById('randomAnswer').value,
                randomPublic: document.getElementById('randomPublic').checked,
                randomAnonymous: document.getElementById('randomAnonymous').checked,
                optionalAnswers: optionalAnswers
            };

            if (isEditMode) {
                const index = diaries.findIndex(d => d.id === todayDiary.id);
                if (index >= 0) {
                    diaries[index] = diary;
                }
            } else {
                diaries.unshift(diary);
            }

            todayDiary = diary;
            saveUserData();

            const successMsg = document.getElementById('successMessage');
            const successText = document.getElementById('successMessageText');
            successText.textContent = isEditMode ? 'æ—¥è¨˜ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼' : 'æ—¥è¨˜ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼';
            successMsg.classList.add('show');
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 3000);

            isEditMode = true;
            document.getElementById('saveBtn').textContent = 'ğŸ”„ æ›´æ–°ã™ã‚‹';

            updateFeedButton();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ä»Šæ—¥ã®æ—¥è¨˜ãƒã‚§ãƒƒã‚¯
        function checkTodayDiary() {
            const todayDate = getTodayJST();
            todayDiary = diaries.find(d => 
                d.postDate === todayDate && 
                d.nickname === currentNickname
            );
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®æ›´æ–°
        function updateFeedButton() {
            const feedBtn = document.getElementById('feedNavBtn');
            if (todayDiary) {
                feedBtn.textContent = 'ã¿ã‚“ãªã®æ—¥è¨˜';
                feedBtn.disabled = false;
                feedBtn.style.opacity = '1';
            } else {
                feedBtn.textContent = 'ã¿ã‚“ãªã®æ—¥è¨˜ ğŸ”’';
                feedBtn.disabled = false;
                feedBtn.style.opacity = '0.5';
            }
        }

        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        function switchPage(page) {
            if (page === 'feed' && !todayDiary) {
                alert('ä»Šæ—¥ã®æ—¥è¨˜ã‚’æ›¸ãã¨ã€ã¿ã‚“ãªã®æ—¥è¨˜ãŒè¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™');
                return;
            }

            currentPage = page;
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            if (page === 'write') {
                document.getElementById('writePage').classList.add('active');
                document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
                document.querySelector('.save-btn-container').style.display = 'block';
            } else if (page === 'my') {
                document.getElementById('myPage').classList.add('active');
                document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
                document.querySelector('.save-btn-container').style.display = 'none';
                renderMyDiaries();
            } else if (page === 'feed') {
                document.getElementById('feedPage').classList.add('active');
                document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
                document.querySelector('.save-btn-container').style.display = 'none';
                renderFeed();
            }
        }

        // è‡ªåˆ†ã®æ—¥è¨˜ä¸€è¦§ã‚’è¡¨ç¤º
        function renderMyDiaries() {
            const myDiariesContent = document.getElementById('myDiariesContent');
            const myDiaries = diaries.filter(d => d.nickname === currentNickname);

            if (myDiaries.length === 0) {
                myDiariesContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div class="empty-state-text">
                            ã¾ã æ—¥è¨˜ã‚’æ›¸ã„ã¦ã„ã¾ã›ã‚“<br>
                            ã€Œæ›¸ãã€ã‚¿ãƒ–ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†
                        </div>
                    </div>
                `;
                return;
            }

            myDiariesContent.innerHTML = myDiaries.map(diary => {
                let contentHtml = '';

                contentHtml += `
                    <div class="my-diary-question">
                        <div class="my-diary-question-title">æ®‹ã—ãŸã„ã“ã¨</div>
                        <div class="my-diary-question-answer">${escapeHtml(diary.memorable)}</div>
                    </div>
                `;

                contentHtml += `
                    <div class="my-diary-question">
                        <div class="my-diary-question-title">è‡ªåˆ†ã«ä¸€è¨€</div>
                        <div class="my-diary-question-answer">${escapeHtml(diary.selfTalk)}</div>
                    </div>
                `;

                if (diary.randomAnswer) {
                    contentHtml += `
                        <div class="my-diary-question">
                            <div class="my-diary-question-title">${escapeHtml(diary.randomQuestion)}</div>
                            <div class="my-diary-question-answer">${escapeHtml(diary.randomAnswer)}</div>
                        </div>
                    `;
                }

                if (diary.optionalAnswers && diary.optionalAnswers.length > 0) {
                    diary.optionalAnswers.forEach(item => {
                        contentHtml += `
                            <div class="my-diary-question">
                                <div class="my-diary-question-title">${escapeHtml(item.question)}</div>
                                <div class="my-diary-question-answer">${escapeHtml(item.answer)}</div>
                            </div>
                        `;
                    });
                }

                return `
                    <div class="my-diary-item">
                        <div class="my-diary-header">
                            <span class="my-diary-date">${formatFullDate(diary.date)}</span>
                            <span class="my-diary-mood">${escapeHtml(diary.mood)}</span>
                        </div>
                        <div class="my-diary-content">
                            ${contentHtml}
                        </div>
                        <button class="delete-diary-btn" onclick="deleteDiary(${diary.id})">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </div>
                `;
            }).join('');
        }

        // æ—¥è¨˜å‰Šé™¤
        function deleteDiary(diaryId) {
            if (!confirm('ã“ã®æ—¥è¨˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            const index = diaries.findIndex(d => d.id === diaryId);
            if (index >= 0) {
                diaries.splice(index, 1);
                saveUserData();
                
                if (todayDiary && todayDiary.id === diaryId) {
                    todayDiary = null;
                    isEditMode = false;
                    document.getElementById('saveBtn').textContent = 'ğŸ“ ä¿å­˜ã™ã‚‹';
                    updateFeedButton();
                }
                
                renderMyDiaries();
            }
        }

        // å®Œå…¨ãªæ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatFullDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const weekday = weekdays[date.getDay()];
            
            return `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰`;
        }

        // XSSå¯¾ç­–ã®HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆä»Šæ—¥ã®æŠ•ç¨¿ã®ã¿ï¼‹å…¬é–‹è¨­å®šå¯¾å¿œï¼‰
        function renderFeed() {
            const feedContent = document.getElementById('feedContent');
            
            if (!todayDiary) {
                feedContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”’</div>
                        <div class="empty-state-text">
                            ä»Šæ—¥ã®æ—¥è¨˜ã‚’æ›¸ãã¨<br>
                            ã¿ã‚“ãªã®æ—¥è¨˜ãŒè¦‹ã‚‰ã‚Œã¾ã™
                        </div>
                    </div>
                `;
                return;
            }

            const todayDate = getTodayJST();
            
            const todayDiaries = diaries.filter(d => 
                d.postDate === todayDate && 
                d.id !== todayDiary.id
            );
            
            if (todayDiaries.length === 0) {
                feedContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div class="empty-state-text">
                            ã¾ã èª°ã‚‚ä»Šæ—¥ã®æ—¥è¨˜ã‚’æ›¸ã„ã¦ã„ã¾ã›ã‚“<br>
                            ã‚ãªãŸãŒæœ€åˆã®ä¸€äººã§ã™
                        </div>
                    </div>
                `;
                return;
            }

            feedContent.innerHTML = todayDiaries.map(diary => {
                let contentHtml = '';

                contentHtml += `
                    <div class="feed-question">
                        <div class="feed-question-title">æ°—åˆ†</div>
                        <div class="feed-question-answer">${escapeHtml(diary.mood)}</div>
                    </div>
                `;

                contentHtml += `
                    <div class="feed-question">
                        <div class="feed-question-title">æ®‹ã—ãŸã„ã“ã¨</div>
                        <div class="feed-question-answer">${escapeHtml(diary.memorable)}</div>
                    </div>
                `;

                contentHtml += `
                    <div class="feed-question">
                        <div class="feed-question-title">è‡ªåˆ†ã«ä¸€è¨€</div>
                        <div class="feed-question-answer">${escapeHtml(diary.selfTalk)}</div>
                    </div>
                `;

                if (diary.randomAnswer && diary.randomPublic) {
                    contentHtml += `
                        <div class="feed-question">
                            <div class="feed-question-title">${escapeHtml(diary.randomQuestion)}</div>
                            <div class="feed-question-answer">${escapeHtml(diary.randomAnswer)}</div>
                        </div>
                    `;
                }

                if (diary.optionalAnswers && diary.optionalAnswers.length > 0) {
                    diary.optionalAnswers.forEach(item => {
                        if (item.isPublic) {
                            contentHtml += `
                                <div class="feed-question">
                                    <div class="feed-question-title">${escapeHtml(item.question)}</div>
                                    <div class="feed-question-answer">${escapeHtml(item.answer)}</div>
                                </div>
                            `;
                        }
                    });
                }

                let authorName = diary.nickname;
                
                const hasAnonymousAnswer = 
                    (diary.randomAnswer && diary.randomPublic && diary.randomAnonymous) ||
                    (diary.optionalAnswers && diary.optionalAnswers.some(a => a.isPublic && a.isAnonymous));
                
                if (hasAnonymousAnswer) {
                    authorName = 'åŒ¿å';
                }

                return `
                    <div class="feed-item">
                        <div class="feed-header">
                            <span class="feed-author">${escapeHtml(authorName)}</span>
                            <span class="feed-date">${formatDate(diary.date)}</span>
                        </div>
                        <div class="feed-content">
                            ${contentHtml}
                        </div>
                        <div class="feed-reactions">
                            <button class="reaction-btn" onclick="sendReaction(${diary.id}, 'ã‚ã‹ã‚‹', this)">
                                ğŸ’­ ã‚ã‹ã‚‹
                            </button>
                            <button class="reaction-btn" onclick="sendReaction(${diary.id}, 'ç¬‘ã£ãŸ', this)">
                                ğŸ˜Š ç¬‘ã£ãŸ
                            </button>
                            <button class="reaction-btn" onclick="sendReaction(${diary.id}, 'ãã£ã¨å…±æ„Ÿ', this)">
                                ğŸ¤ ãã£ã¨å…±æ„Ÿ
                            </button>
                            <button class="reaction-btn" onclick="sendReaction(${diary.id}, 'å¤§ä¸ˆå¤«ãã†', this)">
                                ğŸ‘ å¤§ä¸ˆå¤«ãã†
                            </button>
                            <button class="reaction-btn" onclick="sendReaction(${diary.id}, 'ãã‚Œå¥½ã', this)">
                                â¤ï¸ ãã‚Œå¥½ã
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            
            if (hours < 1) {
                return 'ãŸã£ãŸä»Š';
            } else if (hours < 24) {
                return `${hours}æ™‚é–“å‰`;
            } else {
                return `${Math.floor(hours / 24)}æ—¥å‰`;
            }
        }

        // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡
        function sendReaction(diaryId, reaction, buttonElement) {
            if (buttonElement.classList.contains('sent')) {
                buttonElement.classList.remove('sent');
                alert('ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
            } else {
                buttonElement.parentElement.querySelectorAll('.reaction-btn').forEach(b => {
                    b.classList.remove('sent');
                });
                buttonElement.classList.add('sent');
                alert(`ã€Œ${reaction}ã€ã‚’é€ã‚Šã¾ã—ãŸ`);
            }
        }
    </script>
</body>
</html>

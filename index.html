<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä»Šæ—¥ã®æ—¥è¨˜ v0.0.19</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hiragino Sans', 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      color: #333;
      overflow-x: hidden;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 22px;
      color: #d2691e;
      font-weight: 600;
    }
    .version {
      font-size: 13px;
      color: #999;
      cursor: pointer;
      user-select: none;
    }

    /* ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .tabs {
      display: flex;
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    .tab {
      flex: 1;
      padding: 14px 10px;
      text-align: center;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #666;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      color: #d2691e;
      background: rgba(255,235,205,0.7);
      border-bottom: 3px solid #d2691e;
    }
    .tab:hover { background: rgba(255,248,220,0.5); }

    /* ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ */
    .page { display: none; }
    .page.active { display: block; }

    /* ã‚«ãƒ¼ãƒ‰å…±é€š */
    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    /* æ›¸ããƒšãƒ¼ã‚¸ */
    .question-block {
      margin-bottom: 18px;
      padding: 12px;
      background: rgba(255,250,240,0.8);
      border-radius: 8px;
    }
    .question-label {
      font-size: 15px;
      font-weight: 600;
      color: #d2691e;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .required-badge, .optional-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    .required-badge {
      background: #ffdddd;
      color: #c33;
    }
    .optional-badge {
      background: #e0e0e0;
      color: #666;
    }
    textarea, input[type="text"], select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
    }
    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: #d2691e;
    }
    .mood-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .mood-btn {
      padding: 8px 14px;
      border: 2px solid #ddd;
      border-radius: 20px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .mood-btn.selected {
      background: #d2691e;
      color: #fff;
      border-color: #d2691e;
    }
    .visibility-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .visibility-btn {
      flex: 1;
      min-width: 70px;
      padding: 6px 8px;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      text-align: center;
      transition: all 0.2s;
    }
    .visibility-btn.selected {
      background: #d2691e;
      color: #fff;
      border-color: #d2691e;
    }
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: #d2691e;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 20px;
    }
    .submit-btn:hover { background: #b8521a; transform: translateY(-2px); }
    .submit-btn:active { transform: translateY(0); }

    /* ã¿ã‚“ãªã®æ—¥è¨˜ */
    .notice-banner {
      background: rgba(255,245,210,0.9);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 13px;
      color: #666;
      text-align: center;
      margin-bottom: 15px;
      border: 1px solid rgba(210,105,30,0.2);
    }
    .zone-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .zone-tab {
      flex: 1;
      padding: 10px;
      background: rgba(255,255,255,0.8);
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .zone-tab.active {
      background: #d2691e;
      color: #fff;
      border-color: #d2691e;
    }
    .entry-card {
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    }
    .entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #f0f0f0;
    }
    .entry-author {
      font-weight: 600;
      font-size: 15px;
      color: #d2691e;
    }
    .entry-date {
      font-size: 12px;
      color: #999;
    }
    .entry-content {
      font-size: 14px;
      line-height: 1.6;
      color: #555;
    }
    .qa-item {
      margin-bottom: 10px;
      padding: 8px;
      background: rgba(255,250,240,0.6);
      border-radius: 6px;
    }
    .qa-question {
      font-weight: 600;
      color: #d2691e;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .qa-answer {
      font-size: 14px;
      color: #555;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* ãƒã‚¤æ—¥è¨˜ */
    .edit-btn, .delete-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 8px;
    }
    .edit-btn {
      background: #4CAF50;
      color: #fff;
    }
    .edit-btn:hover { background: #45a049; }
    .delete-btn {
      background: #f44336;
      color: #fff;
    }
    .delete-btn:hover { background: #da190b; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-close {
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    .modal-close:hover { color: #333; }

    /* ãƒã‚¤ãƒšãƒ¼ã‚¸ */
    .settings-section {
      margin-bottom: 20px;
    }
    .settings-section h3 {
      font-size: 16px;
      color: #d2691e;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .friend-code-display {
      background: rgba(255,250,240,0.9);
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      color: #d2691e;
      border: 2px dashed #d2691e;
      margin-bottom: 10px;
    }
    .nickname-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .nickname-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,250,240,0.7);
      padding: 10px;
      border-radius: 6px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nickname-item.active {
      border-color: #d2691e;
      background: rgba(255,235,205,0.9);
    }
    .nickname-item:hover { background: rgba(255,245,220,0.9); }
    .del-nickname-btn {
      padding: 4px 8px;
      background: #f44336;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }
    .del-nickname-btn:hover { background: #da190b; }

    /* ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« */
    .debug-panel {
      display: none;
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.85);
      color: #0f0;
      padding: 12px;
      border-radius: 8px;
      font-size: 11px;
      font-family: monospace;
      max-width: 350px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .debug-panel.active { display: block; }
    .debug-line {
      margin-bottom: 4px;
      line-height: 1.4;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .message {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      z-index: 2000;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .message.success {
      background: #4CAF50;
      color: #fff;
    }
    .message.error {
      background: #f44336;
      color: #fff;
    }
    .message.active {
      display: block;
      animation: fadeInOut 3s forwards;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -10px); }
      10% { opacity: 1; transform: translate(-50%, 0); }
      90% { opacity: 1; transform: translate(-50%, 0); }
      100% { opacity: 0; transform: translate(-50%, -10px); }
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 600px) {
      header h1 { font-size: 18px; }
      .tab { font-size: 13px; padding: 12px 8px; }
      .visibility-btn { font-size: 11px; min-width: 60px; }
    }
  </style>
</head>
<body>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header>
    <h1>ä»Šæ—¥ã®æ—¥è¨˜ ğŸ“–</h1>
    <div class="version" id="versionDisplay">v0.0.19</div>
  </header>

  <div class="container">
    <!-- ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="tabs">
      <div class="tab active" data-page="write">æ›¸ã</div>
      <div class="tab" data-page="my">ãƒã‚¤æ—¥è¨˜</div>
      <div class="tab" data-page="public">ã¿ã‚“ãªã®æ—¥è¨˜</div>
      <div class="tab" data-page="settings">ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
    </div>

    <!-- æ›¸ããƒšãƒ¼ã‚¸ -->
    <div class="page active" id="writePage">
      <div class="card">
        <div id="questionsContainer"></div>
        <button class="submit-btn" id="submitBtn">ä»Šæ—¥ã®æ—¥è¨˜ã‚’æŠ•ç¨¿</button>
      </div>
    </div>

    <!-- ãƒã‚¤æ—¥è¨˜ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="myPage">
      <div id="myEntriesContainer"></div>
    </div>

    <!-- ã¿ã‚“ãªã®æ—¥è¨˜ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="publicPage">
      <div class="notice-banner">
        ä»Šæ—¥ã®åŒºåˆ‡ã‚Šï¼š12:00ï¼ˆ12:00ã€œç¿Œ11:59ï¼‰
      </div>
      <div class="zone-tabs">
        <div class="zone-tab active" data-zone="public">å…¨ä¸–ç•Œ</div>
        <div class="zone-tab" data-zone="friends">å‹é”</div>
      </div>
      <div id="publicEntriesContainer"></div>
    </div>

    <!-- ãƒã‚¤ãƒšãƒ¼ã‚¸ -->
    <div class="page" id="settingsPage">
      <div class="card settings-section">
        <h3>å‹é”ã‚³ãƒ¼ãƒ‰</h3>
        <div class="friend-code-display" id="friendCodeDisplay">---</div>
        <p style="font-size:13px;color:#666;text-align:center;">
          ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å‹é”ã«æ•™ãˆã¦ã€è¨­å®šã‹ã‚‰å‹é”è¿½åŠ ã—ã¦ã‚‚ã‚‰ãŠã†ï¼
        </p>
      </div>

      <div class="card settings-section">
        <h3>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç®¡ç†</h3>
        <div id="nicknameList" class="nickname-list"></div>
        <input type="text" id="newNicknameInput" placeholder="æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " style="margin-top:10px;"/>
        <button class="submit-btn" id="addNicknameBtn">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¿½åŠ </button>
      </div>

      <div class="card settings-section">
        <h3>å‹é”ã‚’è¿½åŠ </h3>
        <input type="text" id="friendCodeInput" placeholder="å‹é”ã®å‹é”ã‚³ãƒ¼ãƒ‰" />
        <button class="submit-btn" id="addFriendBtn" style="margin-top:10px;">å‹é”ã‚’è¿½åŠ </button>
      </div>

      <div class="card settings-section">
        <h3>å¤‰æ›´å±¥æ­´</h3>
        <div style="font-size:12px;color:#666;line-height:1.6;">
          <p>2026-01-18 v0.0.19 ç›´è¿‘3æ—¥è¡¨ç¤ºãƒ»ãƒã‚¤æ—¥è¨˜ç·¨é›†ãƒ»ä½™ç™½æœ€é©åŒ–ãƒ»è‡ªåˆ†éè¡¨ç¤ºãƒ»å‰Šé™¤æ©Ÿèƒ½</p>
          <p>2026-01-18 v0.0.18 æ˜¼12æ™‚åŒºåˆ‡ã‚Šãƒ»å…¨ä¸–ç•Œ3æ—¥è¡¨ç¤ºãƒ»è³ªå•æ›´æ–°</p>
          <p>2026-01-17 v0.0.17 Sheetsä¿å­˜ä¸€æœ¬åŒ–ï¼‹Q&Aæ•´å½¢</p>
          <p>2026-01-xx v0.0.16 ãƒ™ãƒ¼ã‚¹ç‰ˆ</p>
        </div>
      </div>
    </div>

  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="color:#d2691e;">æ—¥è¨˜ã‚’ç·¨é›†</h3>
        <span class="modal-close" id="modalClose">&times;</span>
      </div>
      <div id="editFormContainer"></div>
      <button class="submit-btn" id="saveEditBtn">ä¿å­˜</button>
    </div>
  </div>

  <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div class="message" id="message"></div>

  <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
  <div class="debug-panel" id="debugPanel">
    <div class="debug-line"><strong>DEBUG PANEL</strong></div>
    <div id="debugContent"></div>
  </div>

  <script>
    // ========== å®šæ•° ==========
    const APP_VERSION = 'v0.0.19';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwHN2pvh7y1i5cEEHIWrUP_o6cMnDRCGdfurK0xrw3cVEElKtAepEDZ510JnbDdY3BI/exec';
    const APP_SECRET = 'minnikki-2026';

    // ========== è³ªå•å®šç¾© ==========
    const questions = [
      { id: 'q1', label: 'ä»Šæ—¥ã®æ°—åˆ†ã¯ï¼Ÿ', required: true, type: 'mood' },
      { id: 'q2', label: 'å¬‰ã—ã‹ã£ãŸã“ã¨', required: true, type: 'text' },
      { id: 'q3', label: 'ä»Šæ—¥ã®è‡ªåˆ†è¤’ã‚ã‚‹', required: true, type: 'text' },
      { id: 'q4', label: 'æ„Ÿè¬ã—ãŸã„ã“ã¨ï¼ˆäººã§ã‚‚ç‰©ã§ã‚‚ï¼‰', required: false, type: 'text' },
      { id: 'q5', label: 'ã‚„ã‚‰ã‹ã—ãŸã“ã¨', required: false, type: 'text' },
      { id: 'q6', label: 'ã¡ã‚‡ã£ã¨å¿ƒã«æ®‹ã£ãŸã“ã¨', required: false, type: 'text' },
      { id: 'q7', label: 'æ®‹ã—ãŸã„ã“ã¨', required: false, type: 'text' },
      { id: 'q8', label: 'æ˜æ—¥ã®è‡ªåˆ†ã¸', required: false, type: 'text' }
    ];

    const moodOptions = ['ğŸ˜Š æœ€é«˜', 'ğŸ˜Œ è‰¯ã„', 'ğŸ˜ æ™®é€š', 'ğŸ˜” å¾®å¦™', 'ğŸ˜¢ è¾›ã„'];

    // ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ==========
    let currentUserId = localStorage.getItem('userId') || generateUserId();
    let activeNickname = localStorage.getItem('activeNickname') || '';
    let nicknames = JSON.parse(localStorage.getItem('nicknames') || '[]');
    let friends = JSON.parse(localStorage.getItem('friends') || '[]');
    let currentZone = 'public';
    let allEntries = [];
    let editingEntry = null;

    let debugTapCount = 0;
    let debugPanelVisible = false;

    // ========== åˆæœŸåŒ– ==========
    document.addEventListener('DOMContentLoaded', init);

    function init() {
      console.log('[INIT] ã‚¢ãƒ—ãƒªèµ·å‹•', APP_VERSION);
      if (!localStorage.getItem('userId')) {
        localStorage.setItem('userId', currentUserId);
      }
      if (nicknames.length === 0) {
        promptForNickname();
      } else if (!activeNickname) {
        activeNickname = nicknames[0];
        localStorage.setItem('activeNickname', activeNickname);
      }

      setupTabs();
      setupZoneTabs();
      setupVersionTap();
      renderQuestions();
      renderNicknames();
      renderFriendCode();

      document.getElementById('submitBtn').addEventListener('click', handleSubmit);
      document.getElementById('addNicknameBtn').addEventListener('click', handleAddNickname);
      document.getElementById('addFriendBtn').addEventListener('click', handleAddFriend);
      document.getElementById('modalClose').addEventListener('click', closeEditModal);
      document.getElementById('saveEditBtn').addEventListener('click', handleSaveEdit);

      loadPublicEntries();
      renderMyEntries();
    }

    // ========== ã‚¿ãƒ–åˆ‡æ›¿ ==========
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const targetPage = tab.dataset.page;
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(targetPage + 'Page').classList.add('active');

          if (targetPage === 'public') loadPublicEntries();
          if (targetPage === 'my') renderMyEntries();
        });
      });
    }

    function setupZoneTabs() {
      document.querySelectorAll('.zone-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          currentZone = tab.dataset.zone;
          document.querySelectorAll('.zone-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          renderPublicEntries();
        });
      });
    }

    // ========== ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ãƒƒãƒ— ==========
    function setupVersionTap() {
      const versionEl = document.getElementById('versionDisplay');
      versionEl.addEventListener('click', () => {
        debugTapCount++;
        if (debugTapCount >= 5) {
          debugPanelVisible = !debugPanelVisible;
          document.getElementById('debugPanel').classList.toggle('active', debugPanelVisible);
          debugTapCount = 0;
        }
        setTimeout(() => { debugTapCount = 0; }, 2000);
      });
    }

    // ========== æ—¥ä»˜ã‚­ãƒ¼ç”Ÿæˆï¼ˆJST + 12:00åŒºåˆ‡ã‚Šï¼‰ ==========
    function getDayKey(dateInput) {
      let d = dateInput instanceof Date ? dateInput : new Date(dateInput);
      if (isNaN(d.getTime())) {
        console.warn('[getDayKey] Invalid date:', dateInput);
        d = new Date();
      }
      const jstOffset = 9 * 60 * 60 * 1000;
      const jstTime = new Date(d.getTime() + jstOffset);
      const hour = jstTime.getUTCHours();
      if (hour < 12) {
        jstTime.setUTCDate(jstTime.getUTCDate() - 1);
      }
      const year = jstTime.getUTCFullYear();
      const month = String(jstTime.getUTCMonth() + 1).padStart(2, '0');
      const day = String(jstTime.getUTCDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getRecentDayKeys(days) {
      const keys = [];
      const now = new Date();
      for (let i = 0; i < days; i++) {
        const d = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
        keys.push(getDayKey(d));
      }
      return keys;
    }

    // ========== è³ªå•æç”»ï¼ˆæ›¸ããƒšãƒ¼ã‚¸ï¼‰ ==========
    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';
      questions.forEach(q => {
        const block = document.createElement('div');
        block.className = 'question-block';

        const label = document.createElement('div');
        label.className = 'question-label';
        label.innerHTML = `
          ${q.label}
          ${q.required ? '<span class="required-badge">å¿…é ˆ</span>' : '<span class="optional-badge">ä»»æ„</span>'}
        `;
        block.appendChild(label);

        if (q.type === 'mood') {
          const moodContainer = document.createElement('div');
          moodContainer.className = 'mood-options';
          moodOptions.forEach(mood => {
            const btn = document.createElement('div');
            btn.className = 'mood-btn';
            btn.textContent = mood;
            btn.dataset.qid = q.id;
            btn.addEventListener('click', () => {
              moodContainer.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
              btn.classList.add('selected');
            });
            moodContainer.appendChild(btn);
          });
          block.appendChild(moodContainer);
        } else {
          const textarea = document.createElement('textarea');
          textarea.id = q.id;
          textarea.placeholder = q.required ? 'ï¼ˆå¿…é ˆï¼‰' : 'ï¼ˆä»»æ„ï¼‰';
          block.appendChild(textarea);
        }

        const visRow = document.createElement('div');
        visRow.className = 'visibility-row';
        ['è‡ªåˆ†ç”¨', 'åŒ¿åå…¬é–‹', 'å…¨ä½“å…¬é–‹', 'å‹é”ã®ã¿'].forEach(vis => {
          const btn = document.createElement('div');
          btn.className = 'visibility-btn';
          btn.textContent = vis;
          btn.dataset.qid = q.id;
          btn.dataset.vis = vis;
          if (vis === 'è‡ªåˆ†ç”¨') btn.classList.add('selected');
          btn.addEventListener('click', () => {
            visRow.querySelectorAll('.visibility-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
          });
          visRow.appendChild(btn);
        });
        block.appendChild(visRow);

        container.appendChild(block);
      });
    }

    // ========== æŠ•ç¨¿é€ä¿¡ ==========
    async function handleSubmit() {
      if (!activeNickname) {
        showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const answers = [];
      let hasError = false;

      questions.forEach(q => {
        let answer = '';
        if (q.type === 'mood') {
          const selected = document.querySelector(`.mood-btn[data-qid="${q.id}"].selected`);
          answer = selected ? selected.textContent : '';
        } else {
          answer = (document.getElementById(q.id)?.value || '').trim();
        }

        const visBtn = document.querySelector(`.visibility-btn[data-qid="${q.id}"].selected`);
        const visibility = visBtn ? visBtn.dataset.vis : 'è‡ªåˆ†ç”¨';

        if (q.required && !answer) {
          showMessage(`${q.label} ã¯å¿…é ˆã§ã™`, 'error');
          hasError = true;
        }

        answers.push({
          question: q.label,
          answer,
          visibility
        });
      });

      if (hasError) return;

      const now = new Date();
      const dateKey = getDayKey(now);
      const createdAt = now.toISOString();

      const entry = {
        userId: currentUserId,
        nickname: activeNickname,
        dateKey,
        createdAt,
        content: JSON.stringify(answers),
        secret: APP_SECRET
      };

      console.log('[SUBMIT] é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', entry);

      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'submit', ...entry })
        });
        const result = await res.json();
        console.log('[SUBMIT] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);

        if (result.result === 'ok') {
          showMessage('âœ… é€ä¿¡ã—ã¾ã—ãŸ', 'success');
          clearForm();
          loadPublicEntries();
        } else {
          showMessage('âŒ é€ä¿¡ã§ãã¦ã„ã¾ã›ã‚“: ' + (result.message || 'ä¸æ˜'), 'error');
        }
      } catch (err) {
        console.error('[SUBMIT] ã‚¨ãƒ©ãƒ¼:', err);
        showMessage('âŒ é€ä¿¡ã§ãã¦ã„ã¾ã›ã‚“: ' + err.message, 'error');
      }
    }

    function clearForm() {
      questions.forEach(q => {
        if (q.type === 'mood') {
          document.querySelectorAll(`.mood-btn[data-qid="${q.id}"]`).forEach(b => b.classList.remove('selected'));
        } else {
          const el = document.getElementById(q.id);
          if (el) el.value = '';
        }
        document.querySelectorAll(`.visibility-btn[data-qid="${q.id}"]`).forEach(b => {
          b.classList.remove('selected');
          if (b.dataset.vis === 'è‡ªåˆ†ç”¨') b.classList.add('selected');
        });
      });
    }

    // ========== ã¿ã‚“ãªã®æ—¥è¨˜å–å¾—ãƒ»è¡¨ç¤º ==========
    async function loadPublicEntries() {
      console.log('[LOAD] ã¿ã‚“ãªã®æ—¥è¨˜å–å¾—é–‹å§‹');
      try {
        const res = await fetch(APPS_SCRIPT_URL + '?action=list');
        const data = await res.json();
        console.log('[LOAD] å–å¾—ãƒ‡ãƒ¼ã‚¿:', data);

        if (data.result === 'ok' && Array.isArray(data.entries)) {
          allEntries = data.entries.map(e => {
            let content = e.content;
            if (typeof content === 'string') {
              try {
                content = JSON.parse(content);
              } catch (err) {
                console.warn('[LOAD] content parseå¤±æ•—:', e.content);
                content = [{ question: 'æœ¬æ–‡', answer: e.content, visibility: 'è‡ªåˆ†ç”¨' }];
              }
            }
            if (!Array.isArray(content)) {
              content = [{ question: 'æœ¬æ–‡', answer: String(content), visibility: 'è‡ªåˆ†ç”¨' }];
            }

            let dateKey = e.dateKey || '';
            if (!dateKey && e.createdAt) {
              dateKey = getDayKey(e.createdAt);
            }

            return { ...e, content, dateKey };
          });

          console.log('[LOAD] åŠ å·¥å¾Œ allEntries:', allEntries);
          renderPublicEntries();
        } else {
          console.error('[LOAD] ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', data);
          showMessage('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      } catch (err) {
        console.error('[LOAD] ã‚¨ãƒ©ãƒ¼:', err);
        showMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
      }
    }

    function renderPublicEntries() {
      const container = document.getElementById('publicEntriesContainer');
      container.innerHTML = '';

      const todayKey = getDayKey(new Date());
      const recentKeys = getRecentDayKeys(3);
      console.log('[RENDER] todayKey:', todayKey, 'recentKeys:', recentKeys);

      let filtered = allEntries.filter(e => {
        // è‡ªåˆ†ã®æŠ•ç¨¿ã‚’é™¤å¤–
        if (e.userId === currentUserId) return false;

        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿
        if (!recentKeys.includes(e.dateKey)) return false;

        // ã‚¾ãƒ¼ãƒ³ãƒ•ã‚£ãƒ«ã‚¿
        if (currentZone === 'public') {
          const hasPublic = e.content.some(qa =>
            ['åŒ¿åå…¬é–‹', 'å…¨ä½“å…¬é–‹'].includes(qa.visibility)
          );
          return hasPublic;
        } else {
          const isFriend = friends.includes(e.userId);
          if (!isFriend) return false;
          const hasFriend = e.content.some(qa =>
            qa.visibility === 'å‹é”ã®ã¿'
          );
          return hasFriend;
        }
      });

      console.log('[RENDER] ãƒ•ã‚£ãƒ«ã‚¿å¾Œä»¶æ•°:', filtered.length);

      updateDebugPanel({
        entriesFetched: allEntries.length,
        todayKey,
        match3daysCount: allEntries.filter(e => recentKeys.includes(e.dateKey)).length,
        publicCount: allEntries.filter(e => e.content.some(qa => ['åŒ¿åå…¬é–‹', 'å…¨ä½“å…¬é–‹'].includes(qa.visibility))).length,
        friendsCount: allEntries.filter(e => e.content.some(qa => qa.visibility === 'å‹é”ã®ã¿')).length,
        renderedCount: filtered.length,
        first3: filtered.slice(0, 3).map(e => ({ dateKey: e.dateKey, zone: e.zone || 'unknown', createdAt: e.createdAt }))
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div class="card" style="text-align:center;color:#999;">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const grouped = {};
      filtered.forEach(e => {
        if (!grouped[e.dateKey]) grouped[e.dateKey] = [];
        grouped[e.dateKey].push(e);
      });

      // æ—¥ä»˜é™é †ã§è¡¨ç¤º
      const sortedKeys = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
      sortedKeys.forEach(key => {
        const dateHeader = document.createElement('div');
        dateHeader.style.cssText = 'font-size:14px;font-weight:600;color:#d2691e;margin:15px 0 8px;';
        dateHeader.textContent = key;
        container.appendChild(dateHeader);

        grouped[key].forEach(e => {
          const card = createEntryCard(e, currentZone);
          container.appendChild(card);
        });
      });
    }

    function createEntryCard(entry, zone) {
      const card = document.createElement('div');
      card.className = 'entry-card';

      const header = document.createElement('div');
      header.className = 'entry-header';

      const authorName = zone === 'public' &&
        entry.content.some(qa => qa.visibility === 'åŒ¿åå…¬é–‹')
        ? 'åŒ¿å'
        : entry.nickname || 'åç„¡ã—';

      header.innerHTML = `
        <div class="entry-author">${authorName}</div>
        <div class="entry-date">${formatDate(entry.createdAt)}</div>
      `;
      card.appendChild(header);

      const content = document.createElement('div');
      content.className = 'entry-content';

      const visibleQA = entry.content.filter(qa => {
        if (!qa.answer) return false;
        if (zone === 'public') {
          return ['åŒ¿åå…¬é–‹', 'å…¨ä½“å…¬é–‹'].includes(qa.visibility);
        } else {
          return qa.visibility === 'å‹é”ã®ã¿';
        }
      });

      visibleQA.slice(0, 3).forEach(qa => {
        const qaItem = document.createElement('div');
        qaItem.className = 'qa-item';
        qaItem.innerHTML = `
          <div class="qa-question">${qa.question}</div>
          <div class="qa-answer">${compressAnswer(qa.answer)}</div>
        `;
        content.appendChild(qaItem);
      });

      if (visibleQA.length > 3) {
        const more = document.createElement('div');
        more.style.cssText = 'font-size:12px;color:#999;text-align:center;margin-top:8px;cursor:pointer;';
        more.textContent = 'â€¦ç¶šãã‚’èª­ã‚€';
        more.addEventListener('click', () => {
          content.innerHTML = '';
          visibleQA.forEach(qa => {
            const qaItem = document.createElement('div');
            qaItem.className = 'qa-item';
            qaItem.innerHTML = `
              <div class="qa-question">${qa.question}</div>
              <div class="qa-answer">${compressAnswer(qa.answer)}</div>
            `;
            content.appendChild(qaItem);
          });
        });
        content.appendChild(more);
      }

      card.appendChild(content);
      return card;
    }

    function compressAnswer(text) {
      return text.replace(/\n{3,}/g, '\n\n').trim();
    }

    function formatDate(isoStr) {
      if (!isoStr) return '---';
      const d = new Date(isoStr);
      if (isNaN(d.getTime())) return '---';
      const m = d.getMonth() + 1;
      const day = d.getDate();
      const h = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return `${m}/${day} ${h}:${min}`;
    }

    // ========== ãƒã‚¤æ—¥è¨˜è¡¨ç¤ºãƒ»ç·¨é›†ãƒ»å‰Šé™¤ ==========
    function renderMyEntries() {
      const container = document.getElementById('myEntriesContainer');
      container.innerHTML = '';

      const myEntries = allEntries.filter(e => e.userId === currentUserId);

      if (myEntries.length === 0) {
        container.innerHTML = '<div class="card" style="text-align:center;color:#999;">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      // entryId é€£é–è§£æ±º
      const resolvedEntries = resolveEditChain(myEntries);

      resolvedEntries.forEach(e => {
        const card = document.createElement('div');
        card.className = 'entry-card';

        const header = document.createElement('div');
        header.className = 'entry-header';
        header.innerHTML = `
          <div>
            <div class="entry-author">${e.nickname || 'åç„¡ã—'}</div>
            <div class="entry-date">${formatDate(e.createdAt)}</div>
          </div>
          <div>
            <button class="edit-btn">ç·¨é›†</button>
            <button class="delete-btn">å‰Šé™¤</button>
          </div>
        `;
        card.appendChild(header);

        header.querySelector('.edit-btn').addEventListener('click', () => openEditModal(e));
        header.querySelector('.delete-btn').addEventListener('click', () => handleDeleteEntry(e));

        const content = document.createElement('div');
        content.className = 'entry-content';

        e.content.filter(qa => qa.answer).forEach(qa => {
          const qaItem = document.createElement('div');
          qaItem.className = 'qa-item';
          qaItem.innerHTML = `
            <div class="qa-question">${qa.question} <span style="font-size:11px;color:#999;">(${qa.visibility})</span></div>
            <div class="qa-answer">${compressAnswer(qa.answer)}</div>
          `;
          content.appendChild(qaItem);
        });

        card.appendChild(content);
        container.appendChild(card);
      });
    }

    function resolveEditChain(entries) {
      const entryMap = new Map();
      entries.forEach(e => {
        const eid = e.entryId || generatePseudoEntryId(e);
        entryMap.set(eid, e);
      });

      const result = [];
      const processed = new Set();

      entries.forEach(e => {
        const eid = e.entryId || generatePseudoEntryId(e);
        if (processed.has(eid)) return;

        let current = e;
        let chain = [current];
        let next = current.editOf;

        while (next && entryMap.has(next) && !processed.has(next)) {
          const nextEntry = entryMap.get(next);
          chain.push(nextEntry);
          processed.add(next);
          next = nextEntry.editOf;
        }

        const latest = chain[0];
        processed.add(eid);
        result.push(latest);
      });

      return result.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    }

    function generatePseudoEntryId(entry) {
      return `${entry.userId}_${entry.createdAt}`;
    }

    function openEditModal(entry) {
      editingEntry = entry;
      const modal = document.getElementById('editModal');
      const formContainer = document.getElementById('editFormContainer');
      formContainer.innerHTML = '';

      entry.content.forEach((qa, idx) => {
        const block = document.createElement('div');
        block.className = 'question-block';
        block.innerHTML = `
          <div class="question-label">${qa.question}</div>
          <textarea id="edit_q${idx}" style="min-height:80px;">${qa.answer || ''}</textarea>
        `;
        formContainer.appendChild(block);
      });

      modal.classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      editingEntry = null;
    }

    async function handleSaveEdit() {
      if (!editingEntry) return;

      const updatedContent = editingEntry.content.map((qa, idx) => {
        const val = (document.getElementById(`edit_q${idx}`)?.value || '').trim();
        return { ...qa, answer: val };
      });

      const now = new Date();
      const dateKey = getDayKey(now);
      const createdAt = now.toISOString();

      const newEntry = {
        userId: currentUserId,
        nickname: activeNickname,
        dateKey,
        createdAt,
        content: JSON.stringify(updatedContent),
        entryId: generateEntryId(),
        editOf: editingEntry.entryId || generatePseudoEntryId(editingEntry),
        secret: APP_SECRET
      };

      console.log('[EDIT] ç·¨é›†ä¿å­˜:', newEntry);

      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'submit', ...newEntry })
        });
        const result = await res.json();
        console.log('[EDIT] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);

        if (result.result === 'ok') {
          showMessage('âœ… ç·¨é›†ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
          closeEditModal();
          loadPublicEntries();
          renderMyEntries();
        } else {
          showMessage('âŒ ä¿å­˜ã§ãã¦ã„ã¾ã›ã‚“: ' + (result.message || 'ä¸æ˜'), 'error');
        }
      } catch (err) {
        console.error('[EDIT] ã‚¨ãƒ©ãƒ¼:', err);
        showMessage('âŒ ä¿å­˜ã§ãã¦ã„ã¾ã›ã‚“: ' + err.message, 'error');
      }
    }

    async function handleDeleteEntry(entry) {
      if (!confirm('ã“ã®æ—¥è¨˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ï¼‰')) return;

      const payload = {
        action: 'delete',
        secret: APP_SECRET,
        userId: currentUserId,
        createdAt: entry.createdAt
      };

      console.log('[DELETE] å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', payload);

      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        console.log('[DELETE] ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);

        if (result.result === 'ok') {
          showMessage('âœ… å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
          loadPublicEntries();
          renderMyEntries();
        } else {
          showMessage('âŒ å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + (result.message || 'ä¸æ˜'), 'error');
        }
      } catch (err) {
        console.error('[DELETE] ã‚¨ãƒ©ãƒ¼:', err);
        showMessage('âŒ å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + err.message, 'error');
      }
    }

    function generateEntryId() {
      return `${currentUserId}_${activeNickname}_${Date.now()}`;
    }

    // ========== ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç®¡ç† ==========
    function renderNicknames() {
      const container = document.getElementById('nicknameList');
      container.innerHTML = '';
      if (nicknames.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999;font-size:13px;">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      nicknames.forEach(nick => {
        const item = document.createElement('div');
        item.className = 'nickname-item';
        if (nick === activeNickname) item.classList.add('active');
        item.innerHTML = `
          <span>${nick}</span>
          <button class="del-nickname-btn">å‰Šé™¤</button>
        `;
        item.querySelector('span').addEventListener('click', () => {
          activeNickname = nick;
          localStorage.setItem('activeNickname', activeNickname);
          renderNicknames();
        });
        item.querySelector('.del-nickname-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          handleDeleteNickname(nick);
        });
        container.appendChild(item);
      });
    }

    function handleAddNickname() {
      const input = document.getElementById('newNicknameInput');
      const value = input.value.trim();
      if (!value) {
        showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      if (nicknames.includes(value)) {
        showMessage('æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§ã™', 'error');
        return;
      }
      nicknames.push(value);
      localStorage.setItem('nicknames', JSON.stringify(nicknames));
      if (!activeNickname) {
        activeNickname = value;
        localStorage.setItem('activeNickname', activeNickname);
      }
      input.value = '';
      renderNicknames();
      showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    }

    function handleDeleteNickname(nick) {
      if (!confirm(`ã€Œ${nick}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      nicknames = nicknames.filter(n => n !== nick);
      localStorage.setItem('nicknames', JSON.stringify(nicknames));
      if (activeNickname === nick) {
        activeNickname = nicknames[0] || '';
        localStorage.setItem('activeNickname', activeNickname);
      }
      renderNicknames();
      showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    }

    function promptForNickname() {
      const nick = prompt('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (nick && nick.trim()) {
        nicknames.push(nick.trim());
        localStorage.setItem('nicknames', JSON.stringify(nicknames));
        activeNickname = nick.trim();
        localStorage.setItem('activeNickname', activeNickname);
        renderNicknames();
      }
    }

    // ========== å‹é”ã‚³ãƒ¼ãƒ‰ ==========
    function renderFriendCode() {
      document.getElementById('friendCodeDisplay').textContent = currentUserId;
    }

    function handleAddFriend() {
      const input = document.getElementById('friendCodeInput');
      const code = input.value.trim();
      if (!code) {
        showMessage('å‹é”ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      if (friends.includes(code)) {
        showMessage('æ—¢ã«è¿½åŠ æ¸ˆã¿ã§ã™', 'error');
        return;
      }
      friends.push(code);
      localStorage.setItem('friends', JSON.stringify(friends));
      input.value = '';
      showMessage('å‹é”ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    }

    // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
    function generateUserId() {
      return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'message ' + type;
      msg.classList.add('active');
      setTimeout(() => {
        msg.classList.remove('active');
      }, 3000);
    }

    function updateDebugPanel(data) {
      const content = document.getElementById('debugContent');
      content.innerHTML = `
        <div class="debug-line">APP_VERSION: ${APP_VERSION}</div>
        <div class="debug-line">appsScriptUrl: ${APPS_SCRIPT_URL}</div>
        <div class="debug-line">entriesFetched: ${data.entriesFetched || 0}</div>
        <div class="debug-line">todayKey: ${data.todayKey || '---'}</div>
        <div class="debug-line">match3daysCount: ${data.match3daysCount || 0}</div>
        <div class="debug-line">publicCount: ${data.publicCount || 0}</div>
        <div class="debug-line">friendsCount: ${data.friendsCount || 0}</div>
        <div class="debug-line">renderedCount: ${data.renderedCount || 0}</div>
        <div class="debug-line">first3: ${JSON.stringify(data.first3 || [])}</div>
      `;
    }
  </script>

</body>
</html>

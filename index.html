<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»Šæ—¥ã®æ—¥è¨˜ v0.0.22</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    .version-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .nickname-display {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 8px;
    }
    .tabs {
      display: flex;
      background: #f5f5f5;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      background: transparent;
      font-size: 14px;
      color: #666;
    }
    .tab.active {
      background: white;
      color: #667eea;
      font-weight: bold;
      border-bottom: 3px solid #667eea;
    }
    .tab-content {
      display: none;
      padding: 20px;
      animation: fadeIn 0.3s;
    }
    .tab-content.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
      font-size: 14px;
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .question-label {
      font-weight: 500;
      color: #555;
      font-size: 14px;
    }
    .required-badge, .optional-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 8px;
      font-weight: 500;
    }
    .required-badge {
      background: #ffe0e0;
      color: #d32f2f;
    }
    .optional-badge {
      background: #e3f2fd;
      color: #1976d2;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: border-color 0.3s;
      font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .visibility-group {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .visibility-btn {
      flex: 1;
      min-width: 100px;
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
      text-align: center;
    }
    .visibility-btn:hover {
      border-color: #667eea;
    }
    .visibility-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .btn:active {
      transform: translateY(0);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .feed-zone-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .feed-zone-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    .feed-zone-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    .date-info-banner {
      background: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 13px;
      color: #1565c0;
      text-align: center;
    }
    .debug-info-box {
      background: #fff3e0;
      border: 1px solid #ffb74d;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 11px;
      color: #e65100;
      font-family: monospace;
      line-height: 1.6;
    }
    .my-diary-filter {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .my-diary-filter label {
      font-size: 14px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .my-diary-filter select {
      padding: 6px 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 13px;
      background: white;
    }
    .diary-card {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #e0e0e0;
    }
    .diary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e0e0e0;
    }
    .diary-author {
      font-weight: bold;
      color: #667eea;
      font-size: 15px;
    }
    .diary-date {
      font-size: 12px;
      color: #999;
    }
    .diary-content {
      line-height: 1.5;
    }
    .diary-answer {
      margin-bottom: 8px;
    }
    .diary-question {
      font-weight: 500;
      color: #555;
      margin-bottom: 3px;
      font-size: 13px;
    }
    .diary-answer-text {
      color: #333;
      padding-left: 10px;
      font-size: 14px;
      white-space: pre-wrap;
    }
    .show-more-btn {
      background: #e3f2fd;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      color: #1976d2;
      font-size: 13px;
      margin-top: 8px;
      transition: background 0.3s;
    }
    .show-more-btn:hover {
      background: #bbdefb;
    }
    .login-section {
      text-align: center;
      padding: 40px 20px;
    }
    .login-section h2 {
      margin-bottom: 20px;
      color: #667eea;
    }
    .login-section input {
      max-width: 300px;
      margin: 0 auto 15px;
    }
    .settings-section {
      padding: 0;
    }
    .settings-group {
      margin-bottom: 25px;
    }
    .settings-group h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 16px;
    }
    .nickname-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .nickname-item.active {
      background: #e3f2fd;
      border: 2px solid #667eea;
    }
    .nickname-actions {
      display: flex;
      gap: 8px;
    }
    .icon-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }
    .icon-btn.edit {
      background: #fff3e0;
      color: #f57c00;
    }
    .icon-btn.delete {
      background: #ffebee;
      color: #c62828;
    }
    .icon-btn.select {
      background: #e3f2fd;
      color: #1976d2;
    }
    .icon-btn:hover {
      opacity: 0.8;
    }
    .friend-code-display {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 15px;
    }
    .friend-code-text {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      letter-spacing: 2px;
      margin-top: 8px;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    .message.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #81c784;
    }
    .message.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef5350;
    }
    .debug-panel {
      display: none;
      background: #f5f5f5;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-size: 12px;
      font-family: monospace;
    }
    .debug-panel.visible {
      display: block;
    }
    .debug-panel h4 {
      margin-bottom: 10px;
      color: #667eea;
    }
    .debug-line {
      margin-bottom: 5px;
      color: #555;
    }
    .my-diary-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .my-diary-actions button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s;
    }
    .edit-diary-btn {
      background: #fff3e0;
      color: #f57c00;
    }
    .delete-diary-btn {
      background: #ffebee;
      color: #c62828;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.visible {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 25px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h3 {
      color: #667eea;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    .date-divider {
      background: #667eea;
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      margin: 15px 0 12px 0;
      font-weight: bold;
      font-size: 14px;
      text-align: center;
    }
    .changelog {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 15px;
      font-size: 13px;
      line-height: 1.8;
    }
    .changelog h4 {
      color: #667eea;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="version-badge" id="versionBadge">v0.0.22</div>
      <h1>ğŸ“” ä»Šæ—¥ã®æ—¥è¨˜</h1>
      <div class="nickname-display" id="nicknameDisplay"></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="write">æ›¸ã</button>
      <button class="tab" data-tab="feed">ã¿ã‚“ãªã®è¨˜éŒ²</button>
      <button class="tab" data-tab="my">ãƒã‚¤æ—¥è¨˜</button>
      <button class="tab" data-tab="settings">ãƒã‚¤ãƒšãƒ¼ã‚¸</button>
    </div>

    <!-- æ›¸ãã‚¿ãƒ– -->
    <div class="tab-content active" id="writeTab">
      <div id="loginSection" class="login-section">
        <h2>ã‚ˆã†ã“ãï¼</h2>
        <p style="margin-bottom: 20px; color: #666;">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</p>
        <input type="text" id="loginNickname" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " style="display: block;">
        <button class="btn" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>

      <div id="writeSection" style="display: none;">
        <div id="messageBox"></div>
        <div id="questionsContainer"></div>
        <button class="btn" onclick="saveDiary()">ä¿å­˜ã™ã‚‹</button>
      </div>
    </div>

    <!-- ã¿ã‚“ãªã®è¨˜éŒ²ã‚¿ãƒ– -->
    <div class="tab-content" id="feedTab">
      <div class="date-info-banner">
        ä»Šæ—¥ã®åŒºåˆ‡ã‚Šï¼š12:00ï¼ˆ12:00ã€œç¿Œ11:59ï¼‰
      </div>
      <div class="feed-zone-tabs">
        <button class="feed-zone-btn active" data-zone="public">ğŸŒ å…¨ä¸–ç•Œ</button>
        <button class="feed-zone-btn" data-zone="friends">ğŸ‘¥ å‹é”</button>
      </div>
      <div id="feedContent"></div>
    </div>

    <!-- ãƒã‚¤æ—¥è¨˜ã‚¿ãƒ– -->
    <div class="tab-content" id="myTab">
      <div id="myDiaryDebugInfo" class="debug-info-box"></div>
      <div class="my-diary-filter">
        <label>
          ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§çµã‚Šè¾¼ã¿:
          <select id="nicknameFilter" onchange="renderMyDiary()">
            <option value="">ã™ã¹ã¦</option>
          </select>
        </label>
      </div>
      <div id="myDiaryContent"></div>
    </div>

    <!-- ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚¿ãƒ– -->
    <div class="tab-content" id="settingsTab">
      <div class="settings-section">
        <div class="settings-group">
          <h3>å‹é”ã‚³ãƒ¼ãƒ‰</h3>
          <div class="friend-code-display">
            <div style="font-size: 13px; color: #666;">ã‚ãªãŸã®å‹é”ã‚³ãƒ¼ãƒ‰</div>
            <div class="friend-code-text" id="friendCodeDisplay"></div>
          </div>
        </div>

        <div class="settings-group">
          <h3>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç®¡ç†</h3>
          <div id="nicknamesList"></div>
          <button class="btn btn-secondary" onclick="addNickname()">ï¼‹ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¿½åŠ </button>
        </div>

        <div class="settings-group">
          <h3>å‹é”ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ </h3>
          <input type="text" id="addFriendCodeInput" placeholder="å‹é”ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="margin-bottom: 10px;">
          <button class="btn" onclick="addFriendCode()">å‹é”ã‚’è¿½åŠ </button>
        </div>

        <div class="settings-group">
          <h3>è¦‹ãŸç›®å‰Šé™¤ã®ç®¡ç†</h3>
          <button class="btn" onclick="clearHiddenDiaries()">è¦‹ãŸç›®å‰Šé™¤ã‚’å…¨è§£é™¤</button>
        </div>

        <div class="settings-group">
          <h3>æ›´æ–°å±¥æ­´</h3>
          <div class="changelog">
            <h4>Changelog</h4>
            <div>ï¼ˆ2026-01-18ï¼‰ v0.0.22 ãƒã‚¤æ—¥è¨˜0ä»¶ã«ãªã‚‹ä¸å…·åˆï¼ˆuserIdä¸ä¸€è‡´ï¼‰ã‚’è‡ªå‹•å¾©å…ƒã§ä¿®æ­£</div>
            <div>ï¼ˆ2026-01-18ï¼‰ v0.0.21 ãƒã‚¤æ—¥è¨˜ã®è¡¨ç¤ºä¸å…·åˆä¿®æ­£ï¼‹ç·¨é›†/è¦‹ãŸç›®å‰Šé™¤ã‚’è¿½åŠ </div>
            <div>ï¼ˆ2026-01-18ï¼‰ v0.0.20 ã¿ã‚“ãªã®è¨˜éŒ²ã‚’12:00åŒºåˆ‡ã‚Šã§ç›´è¿‘3æ—¥è¡¨ç¤ºï¼‹è‡ªåˆ†ã®æŠ•ç¨¿ã‚’éè¡¨ç¤ºï¼‹å½¢å¼ã‚¨ãƒ©ãƒ¼è€æ€§</div>
            <div>ï¼ˆ2026-01-18ï¼‰ v0.0.19 ç›´è¿‘3æ—¥è¡¨ç¤ºãƒ»ãƒã‚¤æ—¥è¨˜ç·¨é›†ãƒ»ä½™ç™½æœ€é©åŒ–</div>
            <div>ï¼ˆ2026-01-17ï¼‰ v0.0.18 æ˜¼12æ™‚åŒºåˆ‡ã‚Šãƒ»å…¨ä¸–ç•Œ3æ—¥è¡¨ç¤ºãƒ»è³ªå•æ›´æ–°</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div class="debug-panel" id="debugPanel">
      <h4>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h4>
      <div id="debugContent"></div>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ—¥è¨˜ã‚’ç·¨é›†</h3>
        <button class="modal-close" onclick="closeEditModal()">Ã—</button>
      </div>
      <div id="editQuestionsContainer"></div>
      <button class="btn" onclick="saveEditedDiary()">ä¿å­˜</button>
    </div>
  </div>

  <script>
    const APP_VERSION = '0.0.22';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwHN2pvh7y1i5cEEHIWrUP_o6cMnDRCGdfurK0xrw3cVEElKtAepEDZ510JnbDdY3BI/exec';
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆdeviceUserIdã¯çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„ï¼‰
    let deviceUserId = localStorage.getItem('deviceUserId');
    if (!deviceUserId) {
      deviceUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('deviceUserId', deviceUserId);
    }
    
    let nicknames = JSON.parse(localStorage.getItem('nicknames') || '[]');
    let activeNickname = localStorage.getItem('activeNickname') || '';
    let friendCodes = JSON.parse(localStorage.getItem('friendCodes') || '[]');
    let currentFeedZone = 'public';
    let allEntries = [];
    let editingEntry = null;
    let debugTapCount = 0;
    let hiddenDiaryIds = JSON.parse(localStorage.getItem('hiddenDiaryIds') || '[]');
    let editedDiaryMap = JSON.parse(localStorage.getItem('editedDiaryMap') || '{}');

    // è³ªå•å®šç¾©
    const questions = [
      { id: 'q1', label: 'ä»Šæ—¥ã®æ°—åˆ†ã¯ï¼Ÿ', required: true },
      { id: 'q2', label: 'å¬‰ã—ã‹ã£ãŸã“ã¨', required: true },
      { id: 'q3', label: 'ä»Šæ—¥ã®è‡ªåˆ†è¤’ã‚ã‚‹', required: true },
      { id: 'q4', label: 'æ„Ÿè¬ã—ãŸã„ã“ã¨ï¼ˆäººã§ã‚‚ç‰©ã§ã‚‚ï¼‰', required: false },
      { id: 'q5', label: 'ã‚„ã‚‰ã‹ã—ãŸã“ã¨', required: false },
      { id: 'q6', label: 'ã¡ã‚‡ã£ã¨å¿ƒã«æ®‹ã£ãŸã“ã¨', required: false },
      { id: 'q7', label: 'æ®‹ã—ãŸã„ã“ã¨', required: false },
      { id: 'q8', label: 'æ˜æ—¥ã®è‡ªåˆ†ã¸', required: false }
    ];

    // å®‰å®šã—ãŸä¸€æ„ãªdiaryIdã‚’ç”Ÿæˆ
    function generateDiaryId(entry) {
      const createdAt = entry.createdAt || entry.date || '';
      const userId = entry.userId || '';
      const nickname = entry.nickname || '';
      return `${createdAt}|${userId}|${nickname}`;
    }

    // deviceUserIdè‡ªå‹•å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯
    function attemptAutoRestore(myEntriesCount) {
      console.log('=== è‡ªå‹•å¾©å…ƒãƒã‚§ãƒƒã‚¯é–‹å§‹ ===');
      
      // æ¡ä»¶ãƒã‚§ãƒƒã‚¯
      if (allEntries.length === 0) {
        console.log('å¾©å…ƒä¸è¦: entriesç·æ•°ãŒ0');
        return { shouldRestore: false };
      }
      
      if (myEntriesCount > 0) {
        console.log('å¾©å…ƒä¸è¦: ã™ã§ã«ãƒã‚¤æ—¥è¨˜ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹');
        return { shouldRestore: false };
      }
      
      // device_ ã§å§‹ã¾ã‚‹ userId ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      const deviceEntries = allEntries.filter(e => {
        const userId = String(e.userId || '');
        return userId.startsWith('device_');
      });
      
      if (deviceEntries.length === 0) {
        console.log('å¾©å…ƒä¸è¦: device_ ã§å§‹ã¾ã‚‹ userId ãŒå­˜åœ¨ã—ãªã„');
        return { shouldRestore: false };
      }
      
      console.log(`device_ ã§å§‹ã¾ã‚‹æŠ•ç¨¿: ${deviceEntries.length}ä»¶`);
      
      // è‡ªåˆ†ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¸€è¦§ã«å«ã¾ã‚Œã‚‹æŠ•ç¨¿ã‚’æŠ½å‡º
      const myNicknameEntries = allEntries.filter(e => {
        return nicknames.includes(e.nickname);
      });
      
      console.log(`è‡ªåˆ†ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¸€è¦§ã«å«ã¾ã‚Œã‚‹æŠ•ç¨¿: ${myNicknameEntries.length}ä»¶`);
      
      if (myNicknameEntries.length === 0) {
        console.log('å¾©å…ƒä¸è¦: è‡ªåˆ†ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®æŠ•ç¨¿ãŒå­˜åœ¨ã—ãªã„');
        return { shouldRestore: false };
      }
      
      // æœ€é »å‡ºã® userId ã‚’å–å¾—
      const userIdCount = {};
      myNicknameEntries.forEach(e => {
        const userId = String(e.userId || '');
        if (userId) {
          userIdCount[userId] = (userIdCount[userId] || 0) + 1;
        }
      });
      
      let candidateUserId = null;
      let maxCount = 0;
      Object.keys(userIdCount).forEach(userId => {
        if (userIdCount[userId] > maxCount) {
          maxCount = userIdCount[userId];
          candidateUserId = userId;
        }
      });
      
      console.log('å€™è£œuserId:', candidateUserId, 'å‡ºç¾å›æ•°:', maxCount);
      
      if (!candidateUserId || !candidateUserId.startsWith('device_')) {
        console.log('å¾©å…ƒä¸è¦: å€™è£œuserIdãŒ device_ ã§å§‹ã¾ã‚‰ãªã„');
        return { shouldRestore: false, candidateUserId };
      }
      
      console.log('å¾©å…ƒææ¡ˆ: ã‚ã‚Š');
      return { shouldRestore: true, candidateUserId };
    }

    // åˆæœŸåŒ–
    function init() {
      try {
        updateNicknameDisplay();
        updateFriendCodeDisplay();
        setupTabs();
        setupFeedZoneTabs();
        setupVersionBadge();
        
        if (activeNickname) {
          showWriteSection();
          renderQuestions();
        } else {
          showLoginSection();
        }

        loadFeed();
        loadMyDiary();
        renderNicknamesList();
        updateNicknameFilterOptions();
      } catch (error) {
        console.error('Init error:', error);
        updateDebugPanel({ error: error.message });
      }
    }

    // æ—¥ä»˜ã‚­ãƒ¼ç”Ÿæˆï¼ˆJSTã€12:00åŒºåˆ‡ã‚Šï¼‰
    function generateDateKey(dateInput) {
      try {
        const date = dateInput ? new Date(dateInput) : new Date();
        const jstOffset = 9 * 60; // JST = UTC+9
        const utcTime = date.getTime() + (date.getTimezoneOffset() * 60000);
        const jstTime = new Date(utcTime + (jstOffset * 60000));
        
        const hour = jstTime.getHours();
        
        // 0:00-11:59 ã¯å‰æ—¥æ‰±ã„
        if (hour < 12) {
          jstTime.setDate(jstTime.getDate() - 1);
        }
        
        const year = jstTime.getFullYear();
        const month = String(jstTime.getMonth() + 1).padStart(2, '0');
        const day = String(jstTime.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
      } catch (error) {
        console.error('DateKey generation error:', error);
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
    }

    // contentãƒ‘ãƒ¼ã‚¹ï¼ˆå‹ãƒ–ãƒ¬å¸åï¼‰
    function parseContent(content) {
      if (typeof content === 'string') {
        try {
          return JSON.parse(content);
        } catch (e) {
          console.warn('Content parse failed, returning raw:', content);
          return { _raw: content };
        }
      } else if (typeof content === 'object' && content !== null) {
        return content;
      } else {
        return { _raw: String(content) };
      }
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(targetTab + 'Tab').classList.add('active');
          
          if (targetTab === 'feed') {
            loadFeed();
          } else if (targetTab === 'my') {
            loadMyDiary();
          } else if (targetTab === 'settings') {
            renderNicknamesList();
          }
        });
      });
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰ã‚¾ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆ
    function setupFeedZoneTabs() {
      document.querySelectorAll('.feed-zone-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.feed-zone-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFeedZone = btn.dataset.zone;
          renderFeed();
        });
      });
    }

    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¸è¨­å®šï¼ˆ5å›ã‚¿ãƒƒãƒ—ã§ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼‰
    function setupVersionBadge() {
      const badge = document.getElementById('versionBadge');
      badge.addEventListener('click', () => {
        debugTapCount++;
        if (debugTapCount >= 5) {
          const debugPanel = document.getElementById('debugPanel');
          debugPanel.classList.toggle('visible');
          debugTapCount = 0;
        }
        setTimeout(() => { debugTapCount = 0; }, 2000);
      });
    }

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    function handleLogin() {
      const nickname = document.getElementById('loginNickname').value.trim();
      if (!nickname) {
        showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      if (!nicknames.includes(nickname)) {
        nicknames.push(nickname);
        localStorage.setItem('nicknames', JSON.stringify(nicknames));
      }
      
      activeNickname = nickname;
      localStorage.setItem('activeNickname', activeNickname);
      
      showWriteSection();
      renderQuestions();
      updateNicknameDisplay();
      updateNicknameFilterOptions();
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
    function showLoginSection() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('writeSection').style.display = 'none';
    }

    // æ›¸ãç”»é¢è¡¨ç¤º
    function showWriteSection() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('writeSection').style.display = 'block';
    }

    // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¡¨ç¤ºæ›´æ–°
    function updateNicknameDisplay() {
      const display = document.getElementById('nicknameDisplay');
      if (activeNickname) {
        display.textContent = `ã“ã‚“ã«ã¡ã¯ã€${activeNickname}ã•ã‚“`;
      } else {
        display.textContent = '';
      }
    }

    // å‹é”ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
    function updateFriendCodeDisplay() {
      document.getElementById('friendCodeDisplay').textContent = deviceUserId.substr(0, 8).toUpperCase();
    }

    // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãƒ•ã‚£ãƒ«ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
    function updateNicknameFilterOptions() {
      const select = document.getElementById('nicknameFilter');
      if (!select) return;
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">ã™ã¹ã¦</option>';
      
      nicknames.forEach(nickname => {
        const option = document.createElement('option');
        option.value = nickname;
        option.textContent = nickname;
        select.appendChild(option);
      });
      
      select.value = currentValue;
    }

    // è³ªå•ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderQuestions(answersData = null) {
      try {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';
        
        questions.forEach(q => {
          const formGroup = document.createElement('div');
          formGroup.className = 'form-group';
          
          const header = document.createElement('div');
          header.className = 'question-header';
          
          const label = document.createElement('div');
          label.className = 'question-label';
          label.textContent = q.label;
          
          const badge = document.createElement('span');
          badge.className = q.required ? 'required-badge' : 'optional-badge';
          badge.textContent = q.required ? 'å¿…é ˆ' : 'ä»»æ„';
          
          header.appendChild(label);
          header.appendChild(badge);
          formGroup.appendChild(header);
          
          const textarea = document.createElement('textarea');
          textarea.id = q.id;
          textarea.placeholder = q.required ? 'å…¥åŠ›ã—ã¦ãã ã•ã„' : 'ä»»æ„';
          if (answersData) {
            const answer = answersData.find(a => a.id === q.id);
            if (answer) textarea.value = answer.value || '';
          }
          formGroup.appendChild(textarea);
          
          const visibilityGroup = document.createElement('div');
          visibilityGroup.className = 'visibility-group';
          
          const visibilityOptions = [
            { value: 'private', label: 'ğŸ”’ è‡ªåˆ†ç”¨', emoji: 'ğŸ”’' },
            { value: 'anonymous', label: 'ğŸ‘¤ åŒ¿åå…¬é–‹', emoji: 'ğŸ‘¤' },
            { value: 'public', label: 'ğŸŒ å…¨ä½“å…¬é–‹', emoji: 'ğŸŒ' },
            { value: 'friends', label: 'ğŸ‘¥ å‹é”ã®ã¿', emoji: 'ğŸ‘¥' }
          ];
          
          visibilityOptions.forEach(opt => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'visibility-btn';
            btn.dataset.question = q.id;
            btn.dataset.visibility = opt.value;
            btn.textContent = opt.label;
            
            if (answersData) {
              const answer = answersData.find(a => a.id === q.id);
              if (answer && answer.visibility === opt.value) {
                btn.classList.add('active');
              }
            } else if (opt.value === 'public') {
              btn.classList.add('active');
            }
            
            btn.addEventListener('click', function() {
              document.querySelectorAll(`.visibility-btn[data-question="${q.id}"]`)
                .forEach(b => b.classList.remove('active'));
              this.classList.add('active');
            });
            
            visibilityGroup.appendChild(btn);
          });
          
          formGroup.appendChild(visibilityGroup);
          container.appendChild(formGroup);
        });
        
        updateDebugPanel({ questionsCount: questions.length });
      } catch (error) {
        console.error('Render questions error:', error);
        updateDebugPanel({ renderError: error.message });
      }
    }

    // æ—¥è¨˜ä¿å­˜
    async function saveDiary() {
      const answers = [];
      let hasRequiredEmpty = false;
      
      questions.forEach(q => {
        const textarea = document.getElementById(q.id);
        const value = textarea ? textarea.value.trim() : '';
        
        if (q.required && !value) {
          hasRequiredEmpty = true;
        }
        
        const activeBtn = document.querySelector(`.visibility-btn[data-question="${q.id}"].active`);
        const visibility = activeBtn ? activeBtn.dataset.visibility : 'public';
        
        answers.push({
          id: q.id,
          label: q.label,
          value: value,
          visibility: visibility
        });
      });
      
      if (hasRequiredEmpty) {
        showMessage('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      const dateKey = generateDateKey();
      const entryId = `${deviceUserId}_${activeNickname}_${dateKey}_${Date.now()}`;
      
      const diaryData = {
        action: 'submit',
        userId: deviceUserId,
        nickname: activeNickname,
        date: new Date().toISOString(),
        dateKey: dateKey,
        content: JSON.stringify({ answers }),
        entryId: entryId,
        createdAt: new Date().toISOString()
      };
      
      console.log('Saving diary:', diaryData);
      
      try {
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(diaryData)
        });
        
        const result = await response.json();
        console.log('Save result:', result);
        
        if (result.success) {
          showMessage('é€ä¿¡ã—ã¾ã—ãŸ', 'success');
          questions.forEach(q => {
            const textarea = document.getElementById(q.id);
            if (textarea) textarea.value = '';
          });
          loadFeed();
          loadMyDiary();
        } else {
          throw new Error(result.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('Save error:', error);
        showMessage('é€ä¿¡ã§ãã¦ã„ã¾ã›ã‚“: ' + error.message, 'error');
      }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿
    async function loadFeed() {
      try {
        const url = `${APPS_SCRIPT_URL}?action=list`;
        console.log('Fetching from:', url);
        
        const response = await fetch(url);
        const text = await response.text();
        console.log('Raw response:', text.substring(0, 500));
        
        const data = JSON.parse(text);
        console.log('Parsed data:', data);
        
        // Apps Scriptå½¢å¼ã®è¿”å´ã«å¯¾å¿œ
        if (!data || data.result !== 'ok' || !Array.isArray(data.entries)) {
          console.error('Invalid data format. Full response:', text);
          throw new Error('Invalid data format');
        }
        
        allEntries = data.entries;
        console.log('Total entries:', allEntries.length);
        if (allEntries.length > 0) {
          console.log('First entry:', allEntries[0]);
        }
        renderFeed();
        
        updateDebugPanel({
          lastFetchStatus: 'success',
          entriesFetched: allEntries.length
        });
      } catch (error) {
        console.error('Load feed error:', error);
        document.getElementById('feedContent').innerHTML = 
          `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p><p style="font-size: 12px; color: #999;">${error.message}</p></div>`;
        
        updateDebugPanel({
          lastFetchStatus: 'error',
          error: error.message
        });
      }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰è¡¨ç¤º
    function renderFeed() {
      const container = document.getElementById('feedContent');
      const todayKey = generateDateKey();
      
      console.log('Rendering feed, zone:', currentFeedZone, 'todayKey:', todayKey);
      
      // æ—¥ä»˜ã‚­ãƒ¼è¨ˆç®—ï¼ˆcreatedAtåŸºæº–ï¼‰
      const entriesWithDateKey = allEntries.map(entry => {
        const dateKey = generateDateKey(entry.createdAt || entry.date);
        return { ...entry, calculatedDateKey: dateKey };
      });
      
      console.log('Entries with dateKey:', entriesWithDateKey.slice(0, 3));
      
      // è‡ªåˆ†ã®æŠ•ç¨¿ã‚’é™¤å¤–
      let filtered = entriesWithDateKey.filter(entry => {
        const isSelf = entry.userId === deviceUserId && entry.nickname === activeNickname;
        return !isSelf;
      });
      
      if (currentFeedZone === 'public') {
        // å…¨ä¸–ç•Œ: ç›´è¿‘3æ—¥åˆ†
        const now = new Date();
        const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        const dayBefore = new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000);
        
        const todayKey = generateDateKey(now);
        const yesterdayKey = generateDateKey(yesterday);
        const dayBeforeKey = generateDateKey(dayBefore);
        const targetDays = [todayKey, yesterdayKey, dayBeforeKey];
        
        console.log('Target days:', targetDays);
        
        filtered = filtered.filter(entry => {
          const matchDay = targetDays.includes(entry.calculatedDateKey);
          if (entry.zone === 'friends') return false;
          return matchDay;
        });
        
        console.log('Public filtered count:', filtered.length);
      } else {
        // å‹é”: zone ãŒ friends ã®ã‚‚ã®
        filtered = filtered.filter(entry => entry.zone === 'friends');
        console.log('Friends filtered count:', filtered.length);
      }
      
      // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
      filtered.sort((a, b) => {
        const dateA = new Date(a.createdAt || a.date);
        const dateB = new Date(b.createdAt || b.date);
        return dateB - dateA;
      });
      
      updateDebugPanel({
        todayKey: todayKey,
        match3daysCount: filtered.length,
        publicCount: entriesWithDateKey.filter(e => e.zone !== 'friends' && !(e.userId === deviceUserId && e.nickname === activeNickname)).length,
        friendsCount: entriesWithDateKey.filter(e => e.zone === 'friends' && !(e.userId === deviceUserId && e.nickname === activeNickname)).length,
        renderedCount: filtered.length
      });
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }
      
      // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groupedByDate = {};
      filtered.forEach(entry => {
        const dateKey = entry.calculatedDateKey;
        if (!groupedByDate[dateKey]) {
          groupedByDate[dateKey] = [];
        }
        groupedByDate[dateKey].push(entry);
      });
      
      container.innerHTML = '';
      
      Object.keys(groupedByDate).sort().reverse().forEach(dateKey => {
        const divider = document.createElement('div');
        divider.className = 'date-divider';
        divider.textContent = dateKey;
        container.appendChild(divider);
        
        groupedByDate[dateKey].forEach(entry => {
          const card = createDiaryCard(entry);
          container.appendChild(card);
        });
      });
    }

    // æ—¥è¨˜ã‚«ãƒ¼ãƒ‰ä½œæˆ
    function createDiaryCard(entry, isMyDiary = false) {
      const card = document.createElement('div');
      card.className = 'diary-card';
      
      const header = document.createElement('div');
      header.className = 'diary-header';
      
      const author = document.createElement('div');
      author.className = 'diary-author';
      
      let displayName = entry.nickname || 'åŒ¿å';
      if (entry.zone === 'anonymous' || !entry.nickname) {
        displayName = 'åŒ¿å';
      }
      author.textContent = displayName;
      
      const date = document.createElement('div');
      date.className = 'diary-date';
      const dateKey = generateDateKey(entry.createdAt || entry.date);
      date.textContent = dateKey;
      
      header.appendChild(author);
      header.appendChild(date);
      card.appendChild(header);
      
      const content = document.createElement('div');
      content.className = 'diary-content';
      
      // contentã‚’å®‰å…¨ã«ãƒ‘ãƒ¼ã‚¹
      const parsedContent = parseContent(entry.content);
      let answers = [];
      
      if (parsedContent.answers && Array.isArray(parsedContent.answers)) {
        answers = parsedContent.answers;
      } else if (parsedContent._raw) {
        // ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã¯_rawã‚’è¡¨ç¤º
        const answerDiv = document.createElement('div');
        answerDiv.className = 'diary-answer';
        const answerText = document.createElement('div');
        answerText.className = 'diary-answer-text';
        answerText.textContent = parsedContent._raw;
        answerDiv.appendChild(answerText);
        content.appendChild(answerDiv);
        card.appendChild(content);
        return card;
      }
      
      // ç©ºã§ãªã„å›ç­”ã®ã¿è¡¨ç¤º
      const nonEmptyAnswers = answers.filter(a => a.value && a.value.trim());
      
      if (nonEmptyAnswers.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'diary-answer-text';
        emptyDiv.textContent = 'ï¼ˆå†…å®¹ãªã—ï¼‰';
        emptyDiv.style.color = '#999';
        content.appendChild(emptyDiv);
        card.appendChild(content);
        return card;
      }
      
      const displayCount = Math.min(3, nonEmptyAnswers.length);
      
      for (let i = 0; i < displayCount; i++) {
        const answer = nonEmptyAnswers[i];
        const answerDiv = document.createElement('div');
        answerDiv.className = 'diary-answer';
        
        const questionLabel = document.createElement('div');
        questionLabel.className = 'diary-question';
        questionLabel.textContent = answer.label || 'è³ªå•';
        
        const answerText = document.createElement('div');
        answerText.className = 'diary-answer-text';
        // éå‰°æ”¹è¡Œã‚’åœ§ç¸®
        const cleanedText = answer.value.trim().replace(/\n{3,}/g, '\n\n');
        answerText.textContent = cleanedText;
        
        answerDiv.appendChild(questionLabel);
        answerDiv.appendChild(answerText);
        content.appendChild(answerDiv);
      }
      
      if (nonEmptyAnswers.length > 3) {
        const showMoreBtn = document.createElement('button');
        showMoreBtn.className = 'show-more-btn';
        showMoreBtn.textContent = 'ç¶šãã‚’èª­ã‚€';
        showMoreBtn.onclick = () => {
          for (let i = displayCount; i < nonEmptyAnswers.length; i++) {
            const answer = nonEmptyAnswers[i];
            const answerDiv = document.createElement('div');
            answerDiv.className = 'diary-answer';
            
            const questionLabel = document.createElement('div');
            questionLabel.className = 'diary-question';
            questionLabel.textContent = answer.label || 'è³ªå•';
            
            const answerText = document.createElement('div');
            answerText.className = 'diary-answer-text';
            const cleanedText = answer.value.trim().replace(/\n{3,}/g, '\n\n');
            answerText.textContent = cleanedText;
            
            answerDiv.appendChild(questionLabel);
            answerDiv.appendChild(answerText);
            content.appendChild(answerDiv);
          }
          showMoreBtn.remove();
        };
        content.appendChild(showMoreBtn);
      }
      
      card.appendChild(content);
      
      // ãƒã‚¤æ—¥è¨˜ã®å ´åˆã¯ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³
      if (isMyDiary) {
        const actions = document.createElement('div');
        actions.className = 'my-diary-actions';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-diary-btn';
        editBtn.textContent = 'âœï¸ ç·¨é›†';
        editBtn.onclick = () => openEditModal(entry);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-diary-btn';
        deleteBtn.textContent = 'ğŸ—‘ å‰Šé™¤ï¼ˆè¦‹ãŸç›®ï¼‰';
        deleteBtn.onclick = () => deleteDiaryVisual(entry);
        
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        card.appendChild(actions);
      }
      
      return card;
    }

    // ãƒã‚¤æ—¥è¨˜èª­ã¿è¾¼ã¿
    async function loadMyDiary() {
      if (allEntries.length === 0) {
        await loadFeed();
      }
      renderMyDiary();
    }

    // ãƒã‚¤æ—¥è¨˜è¡¨ç¤º
    function renderMyDiary() {
      console.log('=== ãƒã‚¤æ—¥è¨˜è¡¨ç¤ºé–‹å§‹ ===');
      console.log('deviceUserId:', deviceUserId);
      console.log('activeNickname:', activeNickname);
      console.log('entriesç·æ•°:', allEntries.length);
      
      const container = document.getElementById('myDiaryContent');
      const debugBox = document.getElementById('myDiaryDebugInfo');
      const nicknameFilter = document.getElementById('nicknameFilter');
      const selectedNickname = nicknameFilter ? nicknameFilter.value : '';
      
      // userIdã®ã¿ã§æŠ½å‡ºï¼ˆnicknameã¯ä»»æ„ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
      let myEntries = allEntries.filter(entry => {
        const entryUserId = String(entry.userId || '');
        return entryUserId === deviceUserId;
      });
      
      console.log('userIdæŠ½å‡ºå¾Œã®ä»¶æ•°:', myEntries.length);
      
      // è‡ªå‹•å¾©å…ƒãƒã‚§ãƒƒã‚¯
      const restoreResult = attemptAutoRestore(myEntries.length);
      
      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
      const entryUserIds = allEntries.slice(0, 3).map((e, i) => `[${i}] ${e.userId || 'ãªã—'}`).join(', ');
      let debugHtml = `
        <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
        deviceUserId: ${deviceUserId}<br>
        entriesç·æ•°: ${allEntries.length}<br>
        myEntriesä»¶æ•°ï¼ˆçµã‚Šè¾¼ã¿å‰ï¼‰: ${myEntries.length}<br>
        å…ˆé ­3ä»¶ã®userId: ${entryUserIds || 'ãªã—'}
      `;
      
      if (restoreResult.candidateUserId) {
        debugHtml += `<br>candidateUserId: ${restoreResult.candidateUserId}<br>`;
        debugHtml += `å¾©å…ƒææ¡ˆ: ${restoreResult.shouldRestore ? 'ã‚ã‚Š' : 'ãªã—'}`;
      } else {
        debugHtml += `<br>å¾©å…ƒææ¡ˆ: ãªã—`;
      }
      
      debugBox.innerHTML = debugHtml;
      
      // å¾©å…ƒææ¡ˆãŒã‚ã‚‹å ´åˆã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
      if (restoreResult.shouldRestore && restoreResult.candidateUserId) {
        const confirmed = confirm(
          'ãƒã‚¤æ—¥è¨˜ãŒè¡¨ç¤ºã•ã‚Œãªã„ãŸã‚ã€éå»ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦ç«¯æœ«IDã‚’å¾©å…ƒã—ã¾ã™ã€‚\n' +
          'å¾©å…ƒã™ã‚‹ã¨ãƒã‚¤æ—¥è¨˜ãŒè¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
        );
        
        if (confirmed) {
          console.log('å¾©å…ƒå®Ÿè¡Œ:', restoreResult.candidateUserId);
          localStorage.setItem('deviceUserId', restoreResult.candidateUserId);
          location.reload();
          return;
        } else {
          console.log('å¾©å…ƒã‚­ãƒ£ãƒ³ã‚»ãƒ«');
        }
      }
      
      if (myEntries.length > 0) {
        console.log('å…ˆé ­1ä»¶:', myEntries[0]);
      }
      
      // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ï¼ˆé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
      if (selectedNickname) {
        myEntries = myEntries.filter(entry => entry.nickname === selectedNickname);
        console.log(`ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ "${selectedNickname}"ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®ä»¶æ•°:`, myEntries.length);
      }
      
      // hiddenDiaryIds ã«å«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’é™¤å¤–
      myEntries = myEntries.filter(entry => {
        const diaryId = generateDiaryId(entry);
        return !hiddenDiaryIds.includes(diaryId);
      });
      
      console.log('hiddenDiaryIdsé™¤å¤–å¾Œã®ä»¶æ•°:', myEntries.length);
      
      // ç·¨é›†ã•ã‚ŒãŸã‚¨ãƒ³ãƒˆãƒªã‚’é©ç”¨
      myEntries = myEntries.map(entry => {
        const diaryId = generateDiaryId(entry);
        if (editedDiaryMap[diaryId]) {
          return { ...entry, content: JSON.stringify(editedDiaryMap[diaryId]) };
        }
        return entry;
      });
      
      myEntries.sort((a, b) => {
        const dateA = new Date(a.createdAt || a.date);
        const dateB = new Date(b.createdAt || b.date);
        return dateB - dateA;
      });
      
      if (myEntries.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>ã¾ã æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }
      
      container.innerHTML = '';
      myEntries.forEach(entry => {
        const card = createDiaryCard(entry, true);
        container.appendChild(card);
      });
      
      console.log('=== ãƒã‚¤æ—¥è¨˜è¡¨ç¤ºå®Œäº† ===');
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openEditModal(entry) {
      editingEntry = entry;
      const modal = document.getElementById('editModal');
      modal.classList.add('visible');
      
      const parsedContent = parseContent(entry.content);
      let answers = [];
      
      if (parsedContent.answers && Array.isArray(parsedContent.answers)) {
        answers = parsedContent.answers;
      }
      
      renderEditQuestions(answers);
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeEditModal() {
      const modal = document.getElementById('editModal');
      modal.classList.remove('visible');
      editingEntry = null;
    }

    // ç·¨é›†ç”¨è³ªå•ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderEditQuestions(answersData) {
      const container = document.getElementById('editQuestionsContainer');
      container.innerHTML = '';
      
      questions.forEach(q => {
        const formGroup = document.createElement('div');
        formGroup.className = 'form-group';
        
        const header = document.createElement('div');
        header.className = 'question-header';
        
        const label = document.createElement('div');
        label.className = 'question-label';
        label.textContent = q.label;
        
        const badge = document.createElement('span');
        badge.className = q.required ? 'required-badge' : 'optional-badge';
        badge.textContent = q.required ? 'å¿…é ˆ' : 'ä»»æ„';
        
        header.appendChild(label);
        header.appendChild(badge);
        formGroup.appendChild(header);
        
        const textarea = document.createElement('textarea');
        textarea.id = 'edit_' + q.id;
        textarea.placeholder = q.required ? 'å…¥åŠ›ã—ã¦ãã ã•ã„' : 'ä»»æ„';
        const answer = answersData.find(a => a.id === q.id);
        if (answer) textarea.value = answer.value || '';
        formGroup.appendChild(textarea);
        
        const visibilityGroup = document.createElement('div');
        visibilityGroup.className = 'visibility-group';
        
        const visibilityOptions = [
          { value: 'private', label: 'ğŸ”’ è‡ªåˆ†ç”¨' },
          { value: 'anonymous', label: 'ğŸ‘¤ åŒ¿åå…¬é–‹' },
          { value: 'public', label: 'ğŸŒ å…¨ä½“å…¬é–‹' },
          { value: 'friends', label: 'ğŸ‘¥ å‹é”ã®ã¿' }
        ];
        
        visibilityOptions.forEach(opt => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'visibility-btn';
          btn.dataset.question = 'edit_' + q.id;
          btn.dataset.visibility = opt.value;
          btn.textContent = opt.label;
          
          if (answer && answer.visibility === opt.value) {
            btn.classList.add('active');
          } else if (!answer && opt.value === 'public') {
            btn.classList.add('active');
          }
          
          btn.addEventListener('click', function() {
            document.querySelectorAll(`.visibility-btn[data-question="edit_${q.id}"]`)
              .forEach(b => b.classList.remove('active'));
            this.classList.add('active');
          });
          
          visibilityGroup.appendChild(btn);
        });
        
        formGroup.appendChild(visibilityGroup);
        container.appendChild(formGroup);
      });
    }

    // ç·¨é›†ã—ãŸæ—¥è¨˜ã‚’ä¿å­˜ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰
    function saveEditedDiary() {
      const answers = [];
      let hasRequiredEmpty = false;
      
      questions.forEach(q => {
        const textarea = document.getElementById('edit_' + q.id);
        const value = textarea ? textarea.value.trim() : '';
        
        if (q.required && !value) {
          hasRequiredEmpty = true;
        }
        
        const activeBtn = document.querySelector(`.visibility-btn[data-question="edit_${q.id}"].active`);
        const visibility = activeBtn ? activeBtn.dataset.visibility : 'public';
        
        answers.push({
          id: q.id,
          label: q.label,
          value: value,
          visibility: visibility
        });
      });
      
      if (hasRequiredEmpty) {
        showMessage('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      const diaryId = generateDiaryId(editingEntry);
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ç·¨é›†å†…å®¹ã‚’ä¿å­˜
      editedDiaryMap[diaryId] = { answers };
      localStorage.setItem('editedDiaryMap', JSON.stringify(editedDiaryMap));
      
      showMessage('ç·¨é›†å†…å®¹ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      closeEditModal();
      renderMyDiary();
    }

    // è¦‹ãŸç›®ã ã‘å‰Šé™¤
    function deleteDiaryVisual(entry) {
      if (!confirm('ã“ã®æ—¥è¨˜ã‚’éè¡¨ç¤ºã«ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚Šã¾ã™ï¼‰')) {
        return;
      }
      
      const diaryId = generateDiaryId(entry);
      
      if (!hiddenDiaryIds.includes(diaryId)) {
        hiddenDiaryIds.push(diaryId);
        localStorage.setItem('hiddenDiaryIds', JSON.stringify(hiddenDiaryIds));
      }
      
      showMessage('ã“ã®æ—¥è¨˜ã¯éè¡¨ç¤ºã«ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã£ã¦ã„ã¾ã™ï¼‰', 'success');
      renderMyDiary();
    }

    // è¦‹ãŸç›®å‰Šé™¤ã‚’å…¨è§£é™¤
    function clearHiddenDiaries() {
      if (!confirm('éè¡¨ç¤ºã«ã—ãŸæ—¥è¨˜ã‚’ã™ã¹ã¦è¡¨ç¤ºã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      hiddenDiaryIds = [];
      localStorage.setItem('hiddenDiaryIds', JSON.stringify(hiddenDiaryIds));
      showMessage('éè¡¨ç¤ºã‚’å…¨è§£é™¤ã—ã¾ã—ãŸ', 'success');
      renderMyDiary();
    }

    // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¸€è¦§è¡¨ç¤º
    function renderNicknamesList() {
      const container = document.getElementById('nicknamesList');
      container.innerHTML = '';
      
      if (nicknames.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: 20px;"><p style="color: #999; font-size: 14px;">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
        return;
      }
      
      nicknames.forEach(nickname => {
        const item = document.createElement('div');
        item.className = 'nickname-item';
        if (nickname === activeNickname) {
          item.classList.add('active');
        }
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = nickname;
        if (nickname === activeNickname) {
          nameSpan.textContent += ' âœ“';
        }
        
        const actions = document.createElement('div');
        actions.className = 'nickname-actions';
        
        if (nickname !== activeNickname) {
          const selectBtn = document.createElement('button');
          selectBtn.className = 'icon-btn select';
          selectBtn.textContent = 'é¸æŠ';
          selectBtn.onclick = () => {
            activeNickname = nickname;
            localStorage.setItem('activeNickname', activeNickname);
            updateNicknameDisplay();
            renderNicknamesList();
            renderQuestions();
          };
          actions.appendChild(selectBtn);
        }
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'icon-btn delete';
        deleteBtn.textContent = 'å‰Šé™¤';
        deleteBtn.onclick = () => {
          if (confirm(`${nickname} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            nicknames = nicknames.filter(n => n !== nickname);
            localStorage.setItem('nicknames', JSON.stringify(nicknames));
            if (activeNickname === nickname) {
              activeNickname = nicknames[0] || '';
              localStorage.setItem('activeNickname', activeNickname);
              updateNicknameDisplay();
              if (!activeNickname) {
                showLoginSection();
              }
            }
            renderNicknamesList();
            updateNicknameFilterOptions();
          }
        };
        actions.appendChild(deleteBtn);
        
        item.appendChild(nameSpan);
        item.appendChild(actions);
        container.appendChild(item);
      });
    }

    // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¿½åŠ 
    function addNickname() {
      const nickname = prompt('æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (!nickname) return;
      
      const trimmed = nickname.trim();
      if (!trimmed) {
        showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      if (nicknames.includes(trimmed)) {
        showMessage('ãã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'error');
        return;
      }
      
      nicknames.push(trimmed);
      localStorage.setItem('nicknames', JSON.stringify(nicknames));
      renderNicknamesList();
      updateNicknameFilterOptions();
      showMessage(`${trimmed} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
    }

    // å‹é”ã‚³ãƒ¼ãƒ‰è¿½åŠ 
    function addFriendCode() {
      const input = document.getElementById('addFriendCodeInput');
      const code = input.value.trim();
      
      if (!code) {
        showMessage('å‹é”ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      if (friendCodes.includes(code)) {
        showMessage('ãã®å‹é”ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'error');
        return;
      }
      
      friendCodes.push(code);
      localStorage.setItem('friendCodes', JSON.stringify(friendCodes));
      input.value = '';
      showMessage('å‹é”ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(text, type) {
      const messageBox = document.getElementById('messageBox');
      messageBox.innerHTML = `<div class="message ${type}">${text}</div>`;
      setTimeout(() => {
        messageBox.innerHTML = '';
      }, 3000);
    }

    // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«æ›´æ–°
    function updateDebugPanel(data) {
      const debugContent = document.getElementById('debugContent');
      const debugData = {
        APP_VERSION,
        appsScriptUrl: APPS_SCRIPT_URL,
        ...data
      };
      
      debugContent.innerHTML = Object.entries(debugData)
        .map(([key, value]) => `<div class="debug-line"><strong>${key}:</strong> ${JSON.stringify(value)}</div>`)
        .join('');
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

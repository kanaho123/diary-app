<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã¿ã‚“ãªã®æ—¥è¨˜ - åŒ¿åäº¤æ›æ—¥è¨˜ã‚¢ãƒ—ãƒª</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #FF6B9D;
      --secondary-color: #C44569;
      --background-color: #FFF5F7;
      --card-background: #FFFFFF;
      --text-color: #333333;
      --text-light: #666666;
      --border-color: #FFE0E9;
      --shadow: 0 2px 8px rgba(255, 107, 157, 0.1);
      --shadow-hover: 0 4px 12px rgba(255, 107, 157, 0.2);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0;
    }

    header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .version {
      font-size: 12px;
      opacity: 0.9;
    }

    .tabs {
      display: flex;
      background-color: white;
      border-bottom: 2px solid var(--border-color);
      position: sticky;
      top: 56px;
      z-index: 99;
    }

    .tab {
      flex: 1;
      padding: 14px 8px;
      text-align: center;
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      font-weight: 600;
    }

    .tab:hover {
      background-color: rgba(255, 107, 157, 0.05);
    }

    .tab-content {
      display: none;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
      font-size: 14px;
    }

    input[type="text"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s ease;
      background-color: white;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    button {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      width: 100%;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .card {
      background-color: var(--card-background);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .nickname {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 15px;
    }

    .timestamp {
      font-size: 12px;
      color: var(--text-light);
    }

    .card-content {
      color: var(--text-color);
      line-height: 1.8;
    }

    .question-section {
      margin-bottom: 16px;
    }

    .question-section:last-child {
      margin-bottom: 0;
    }

    .question-label {
      font-weight: 600;
      color: var(--secondary-color);
      margin-bottom: 6px;
      font-size: 13px;
    }

    .answer-text {
      color: var(--text-color);
      font-size: 14px;
      line-height: 1.6;
    }

    .message {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-size: 14px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .message.success {
      background-color: #D4EDDA;
      color: #155724;
      border: 1px solid #C3E6CB;
    }

    .message.error {
      background-color: #F8D7DA;
      color: #721C24;
      border: 1px solid #F5C6CB;
    }

    .message.info {
      background-color: #D1ECF1;
      color: #0C5460;
      border: 1px solid #BEE5EB;
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }

    .no-data-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .settings-section {
      margin-bottom: 24px;
    }

    .settings-section h3 {
      font-size: 16px;
      color: var(--secondary-color);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border-color);
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .button-group button {
      flex: 1;
    }

    .secondary-button {
      background: white;
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
    }

    .secondary-button:hover {
      background-color: var(--primary-color);
      color: white;
    }

    .danger-button {
      background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%);
    }

    .info-text {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 8px;
      line-height: 1.6;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background-color: var(--primary-color);
      color: white;
      margin-left: 8px;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
    }

    .loading::after {
      content: '...';
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .debug-info {
      margin-top: 20px;
      padding: 12px;
      background-color: #f5f5f5;
      border-radius: 8px;
      font-size: 12px;
      color: #666;
      font-family: 'Courier New', monospace;
    }

    .debug-info-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .debug-line {
      margin: 4px 0;
    }

    .changelog {
      background-color: var(--card-background);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      font-size: 13px;
      line-height: 1.8;
    }

    .changelog h4 {
      font-size: 14px;
      color: var(--secondary-color);
      margin-bottom: 10px;
    }

    .changelog-item {
      margin-bottom: 6px;
      padding-left: 12px;
      border-left: 2px solid var(--primary-color);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 24px;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-color);
    }

    .modal-header h3 {
      font-size: 18px;
      color: var(--secondary-color);
    }

    .close {
      font-size: 28px;
      font-weight: bold;
      color: var(--text-light);
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .close:hover {
      color: var(--primary-color);
    }

    .card-actions {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
    }

    .card-actions button {
      flex: 1;
      padding: 8px 12px;
      font-size: 13px;
    }

    .edit-button {
      background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
    }

    .delete-button {
      background: linear-gradient(135deg, #FFA07A 0%, #FF6347 100%);
    }

    .nickname-filter {
      margin-bottom: 16px;
    }

    .nickname-filter label {
      font-size: 13px;
      margin-bottom: 6px;
    }

    .nickname-filter select {
      padding: 8px 12px;
      font-size: 14px;
    }

    .info-banner {
      background-color: #E3F2FD;
      border-left: 4px solid #2196F3;
      padding: 12px 16px;
      margin-bottom: 20px;
      border-radius: 8px;
      font-size: 13px;
      color: #1565C0;
    }

    /* æ°—åˆ†é¸æŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .mood-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }

    .mood-chip {
      padding: 10px 16px;
      border: 2px solid var(--border-color);
      border-radius: 20px;
      background-color: white;
      color: var(--text-color);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .mood-chip:hover {
      border-color: var(--primary-color);
      background-color: rgba(255, 107, 157, 0.05);
    }

    .mood-chip.selected {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <h1>ğŸ“– ã¿ã‚“ãªã®æ—¥è¨˜</h1>
        <span class="version" id="versionDisplay">v0.0.22</span>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('write')">âœï¸ æ›¸ã</button>
      <button class="tab" onclick="switchTab('feed')">ğŸŒ ã¿ã‚“ãªã®è¨˜éŒ²</button>
      <button class="tab" onclick="switchTab('my')">ğŸ“” ãƒã‚¤æ—¥è¨˜</button>
      <button class="tab" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
    </div>

    <!-- æ›¸ã -->
    <div id="writeTab" class="tab-content active">
      <div class="card">
        <h2 style="margin-bottom: 20px; color: var(--secondary-color);">ä»Šæ—¥ã®æ—¥è¨˜ã‚’æ›¸ã“ã†</h2>
        <div id="writeMessage"></div>
        <form id="diaryForm">
          <div class="form-group">
            <label for="q1">ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã ã£ãŸï¼Ÿ</label>
            <textarea id="q1" placeholder="ä»Šæ—¥ã‚ã£ãŸå‡ºæ¥äº‹ã‚„æ„Ÿã˜ãŸã“ã¨ã‚’è‡ªç”±ã«æ›¸ã„ã¦ã­" required></textarea>
          </div>

          <div class="form-group">
            <label>ä»Šæ—¥ã®æ°—åˆ†ã¯ï¼Ÿ</label>
            <div class="mood-selection" id="moodSelection">
              <div class="mood-chip" data-mood="ğŸ˜Š ã¨ã¦ã‚‚è‰¯ã„">ğŸ˜Š ã¨ã¦ã‚‚è‰¯ã„</div>
              <div class="mood-chip" data-mood="ğŸ™‚ è‰¯ã„">ğŸ™‚ è‰¯ã„</div>
              <div class="mood-chip" data-mood="ğŸ˜ æ™®é€š">ğŸ˜ æ™®é€š</div>
              <div class="mood-chip" data-mood="ğŸ˜” å°‘ã—æ‚²ã—ã„">ğŸ˜” å°‘ã—æ‚²ã—ã„</div>
              <div class="mood-chip" data-mood="ğŸ˜¢ æ‚²ã—ã„">ğŸ˜¢ æ‚²ã—ã„</div>
              <div class="mood-chip" data-mood="ğŸ˜¤ ã‚¤ãƒ©ã‚¤ãƒ©">ğŸ˜¤ ã‚¤ãƒ©ã‚¤ãƒ©</div>
              <div class="mood-chip" data-mood="ğŸ˜´ ç–²ã‚ŒãŸ">ğŸ˜´ ç–²ã‚ŒãŸ</div>
              <div class="mood-chip" data-mood="ğŸ˜† æ¥½ã—ã„">ğŸ˜† æ¥½ã—ã„</div>
            </div>
            <input type="hidden" id="q2" required />
          </div>

          <div class="form-group">
            <label for="q3">æ˜æ—¥ã‚„ã‚ŠãŸã„ã“ã¨ã¯ï¼Ÿ</label>
            <textarea id="q3" placeholder="æ˜æ—¥ã®äºˆå®šã‚„æ¥½ã—ã¿ãªã“ã¨ã‚’æ›¸ã„ã¦ã¿ã‚ˆã†"></textarea>
          </div>

          <button type="submit" id="submitBtn">ğŸ“® æŠ•ç¨¿ã™ã‚‹</button>
        </form>
      </div>
    </div>

    <!-- ã¿ã‚“ãªã®è¨˜éŒ² -->
    <div id="feedTab" class="tab-content">
      <div class="info-banner">
        ä»Šæ—¥ã®åŒºåˆ‡ã‚Šï¼š12:00ï¼ˆ12:00ã€œç¿Œ11:59ï¼‰<br>
        ç›´è¿‘3æ—¥åˆ†ã®å…¬é–‹æ—¥è¨˜ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™
      </div>
      <div id="feedContent">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­</div>
      </div>
      <div id="feedDebug" class="debug-info" style="display:none;">
        <div class="debug-info-title">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</div>
        <div id="feedDebugContent"></div>
      </div>
    </div>

    <!-- ãƒã‚¤æ—¥è¨˜ -->
    <div id="myTab" class="tab-content">
      <div class="nickname-filter">
        <label for="nicknameFilter">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ çµã‚Šè¾¼ã¿ï¼š</label>
        <select id="nicknameFilter" onchange="renderMyDiaries()">
          <option value="">ã™ã¹ã¦</option>
        </select>
      </div>
      <div id="myContent">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­</div>
      </div>
      <div id="myDebug" class="debug-info">
        <div class="debug-info-title">ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºç”¨ï¼‰</div>
        <div id="myDebugContent"></div>
      </div>
    </div>

    <!-- è¨­å®š -->
    <div id="settingsTab" class="tab-content">
      <div class="changelog">
        <h4>ğŸ“ å¤‰æ›´å±¥æ­´</h4>
        <div class="changelog-item">ï¼ˆ2026-01-18ï¼‰ v0.0.22 ãƒã‚¤æ—¥è¨˜0ä»¶ã«ãªã‚‹ä¸å…·åˆï¼ˆuserIdä¸ä¸€è‡´ï¼‰ã‚’è‡ªå‹•å¾©å…ƒã§ä¿®æ­£</div>
        <div class="changelog-item">ï¼ˆ2026-01-18ï¼‰ v0.0.21 ãƒã‚¤æ—¥è¨˜ã®è¡¨ç¤ºä¸å…·åˆä¿®æ­£ï¼‹ç·¨é›†/è¦‹ãŸç›®å‰Šé™¤</div>
        <div class="changelog-item">ï¼ˆ2026-01-18ï¼‰ v0.0.20 ã¿ã‚“ãªã®è¨˜éŒ²ã‚’12:00åŒºåˆ‡ã‚Šã§ç›´è¿‘3æ—¥è¡¨ç¤ºï¼‹è‡ªåˆ†ã®æŠ•ç¨¿ã‚’éè¡¨ç¤ºï¼‹å½¢å¼ã‚¨ãƒ©ãƒ¼è€æ€§</div>
        <div class="changelog-item">ï¼ˆ2026-01-18ï¼‰ v0.0.19 ã¿ã‚“ãªã®è¨˜éŒ²ã®è¡¨ç¤º/ä»•æ§˜è¿½åŠ </div>
      </div>

      <div class="settings-section">
        <h3>ğŸ‘¤ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®š</h3>
        <div class="form-group">
          <label for="nicknameInput">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
          <input type="text" id="nicknameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›" />
          <p class="info-text">ã“ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§æ—¥è¨˜ã‚’æŠ•ç¨¿ã—ã¾ã™ã€‚ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã¾ã™ã€‚</p>
        </div>
        <button onclick="saveNickname()">ğŸ’¾ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿å­˜</button>
        <div id="nicknameMessage" style="margin-top:12px;"></div>

        <div style="margin-top: 20px;">
          <h4 style="font-size: 14px; margin-bottom: 8px;">ä¿å­˜æ¸ˆã¿ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¸€è¦§</h4>
          <div id="nicknameList" style="font-size: 13px; color: var(--text-light);"></div>
        </div>
      </div>

      <div class="settings-section">
        <h3>ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
        <p class="info-text">è¦‹ãŸç›®ä¸Šå‰Šé™¤ã—ãŸæ—¥è¨˜ã‚’å…ƒã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
        <button class="secondary-button" onclick="restoreHiddenDiaries()">ğŸ”„ è¦‹ãŸç›®å‰Šé™¤ã‚’å…¨è§£é™¤</button>
        <div id="restoreMessage" style="margin-top:12px;"></div>
      </div>

      <div class="settings-section">
        <h3>â„¹ï¸ ã‚¢ãƒ—ãƒªæƒ…å ±</h3>
        <p class="info-text">
          <strong>ã¿ã‚“ãªã®æ—¥è¨˜ v0.0.22</strong><br>
          åŒ¿åã§æ—¥è¨˜ã‚’æ›¸ã„ã¦ã€ã¿ã‚“ãªã®æ—¥è¨˜ã‚’èª­ã‚‚ã†ã€‚<br>
          ãƒ‡ãƒ¼ã‚¿ã¯Google Sheetsã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
        </p>
      </div>
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ—¥è¨˜ã‚’ç·¨é›†</h3>
        <span class="close" onclick="closeEditModal()">&times;</span>
      </div>
      <div id="editModalMessage"></div>
      <div class="form-group">
        <label for="editQ1">ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã ã£ãŸï¼Ÿ</label>
        <textarea id="editQ1"></textarea>
      </div>
      <div class="form-group">
        <label for="editQ2">ä»Šæ—¥ã®æ°—åˆ†ã¯ï¼Ÿ</label>
        <input type="text" id="editQ2" />
      </div>
      <div class="form-group">
        <label for="editQ3">æ˜æ—¥ã‚„ã‚ŠãŸã„ã“ã¨ã¯ï¼Ÿ</label>
        <textarea id="editQ3"></textarea>
      </div>
      <button onclick="saveEdit()">ğŸ’¾ ä¿å­˜</button>
    </div>
  </div>

  <script>
    const APP_VERSION = 'v0.0.22';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwHN2pvh7y1i5cEEHIWrUP_o6cMnDRCGdfurK0xrw3cVEElKtAepEDZ510JnbDdY3BI/exec';
    const SECRET = 'minnikki-2026';

    let deviceUserId = localStorage.getItem('deviceUserId');
    if (!deviceUserId) {
      deviceUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('deviceUserId', deviceUserId);
    }

    let activeNickname = localStorage.getItem('activeNickname') || '';
    let allEntries = [];
    let editedDiaryMap = JSON.parse(localStorage.getItem('editedDiaryMap') || '{}');
    let hiddenDiaryIds = JSON.parse(localStorage.getItem('hiddenDiaryIds') || '[]');
    let currentEditingId = null;

    document.getElementById('versionDisplay').textContent = APP_VERSION;

    // æ°—åˆ†é¸æŠã®åˆæœŸåŒ–
    document.querySelectorAll('.mood-chip').forEach(chip => {
      chip.addEventListener('click', function() {
        document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
        document.getElementById('q2').value = this.getAttribute('data-mood');
      });
    });

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      const tabs = ['write', 'feed', 'my', 'settings'];
      const index = tabs.indexOf(tabName);
      if (index !== -1) {
        document.querySelectorAll('.tab')[index].classList.add('active');
      }

      document.getElementById(tabName + 'Tab').classList.add('active');

      if (tabName === 'feed') {
        loadFeed();
      } else if (tabName === 'my') {
        renderMyDiaries();
      } else if (tabName === 'settings') {
        loadSettings();
      }
    }

    document.getElementById('diaryForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'é€ä¿¡ä¸­...';

      if (!activeNickname) {
        showMessage('writeMessage', 'error', 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ˆè¨­å®šã‚¿ãƒ–ï¼‰');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“® æŠ•ç¨¿ã™ã‚‹';
        return;
      }

      const answers = {
        q1: document.getElementById('q1').value,
        q2: document.getElementById('q2').value,
        q3: document.getElementById('q3').value
      };

      if (!answers.q2) {
        showMessage('writeMessage', 'error', 'æ°—åˆ†ã‚’é¸æŠã—ã¦ãã ã•ã„');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“® æŠ•ç¨¿ã™ã‚‹';
        return;
      }

      const now = new Date();
      const diaryData = {
        secret: SECRET,
        userId: deviceUserId,
        nickname: activeNickname,
        content: JSON.stringify(answers),
        date: now.toISOString().split('T')[0],
        zone: 'Asia/Tokyo'
      };

      try {
        const url = APPS_SCRIPT_URL + '?action=submit';
        console.log('[POST] é€ä¿¡å…ˆ:', url);
        console.log('[POST] payload:', diaryData);

        await fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          body: JSON.stringify(diaryData)
        });

        console.log('[POST] é€ä¿¡æˆåŠŸï¼ˆno-corsã®ãŸã‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¸é€æ˜ï¼‰');
        showMessage('writeMessage', 'success', 'âœ… é€ä¿¡ã§ãã¾ã—ãŸï¼æ—¥è¨˜ãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸã€‚');
        document.getElementById('diaryForm').reset();
        document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('selected'));

        setTimeout(() => {
          showMessage('writeMessage', '', '');
        }, 3000);

      } catch (error) {
        console.error('[POST] é€ä¿¡å¤±æ•—:', error);
        showMessage('writeMessage', 'error', 'âŒ é€ä¿¡ã§ãã¦ã„ã¾ã›ã‚“: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“® æŠ•ç¨¿ã™ã‚‹';
      }
    });

    function normalizeContent(content) {
      if (typeof content === 'string') {
        try {
          return JSON.parse(content);
        } catch {
          return { _raw: content };
        }
      } else if (typeof content === 'object' && content !== null) {
        return content;
      } else {
        return { _raw: String(content) };
      }
    }

    async function loadFeed() {
      const feedContent = document.getElementById('feedContent');
      feedContent.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­</div>';

      try {
        const url = APPS_SCRIPT_URL + '?action=list';
        console.log('[GET] å–å¾—å…ˆ:', url);
        const response = await fetch(url);
        const data = await response.json();
        console.log('[GET] å—ä¿¡ãƒ‡ãƒ¼ã‚¿:', data);

        if (data.result !== 'ok' || !Array.isArray(data.entries)) {
          feedContent.innerHTML = '<div class="no-data"><div class="no-data-icon">âš ï¸</div><p>ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
          return;
        }

        allEntries = data.entries.map(entry => ({
          ...entry,
          content: normalizeContent(entry.content)
        }));

        renderFeed();
      } catch (error) {
        console.error('[GET] ã‚¨ãƒ©ãƒ¼:', error);
        feedContent.innerHTML = '<div class="no-data"><div class="no-data-icon">âš ï¸</div><p>ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>';
      }
    }

    function renderFeed() {
      const feedContent = document.getElementById('feedContent');
      const now = new Date();
      const jstOffset = 9 * 60;
      const nowJST = new Date(now.getTime() + jstOffset * 60000);

      let todayKeyBase = nowJST.toISOString().split('T')[0];
      const jstHour = nowJST.getUTCHours();
      if (jstHour < 12) {
        const yesterday = new Date(nowJST.getTime() - 24*60*60*1000);
        todayKeyBase = yesterday.toISOString().split('T')[0];
      }

      const targetKeys = [];
      for (let i = 0; i < 3; i++) {
        const d = new Date(todayKeyBase);
        d.setDate(d.getDate() - i);
        targetKeys.push(d.toISOString().split('T')[0]);
      }

      const publicEntries = allEntries.filter(entry => {
        if (entry.userId === deviceUserId && entry.nickname === activeNickname) {
          return false;
        }
        const createdAt = entry.createdAt ? new Date(entry.createdAt) : new Date(entry.date || Date.now());
        const createdJST = new Date(createdAt.getTime() + jstOffset * 60000);
        let dateKeyBase = createdJST.toISOString().split('T')[0];
        const createdHour = createdJST.getUTCHours();
        if (createdHour < 12) {
          const prevDay = new Date(createdJST.getTime() - 24*60*60*1000);
          dateKeyBase = prevDay.toISOString().split('T')[0];
        }
        return targetKeys.includes(dateKeyBase);
      });

      if (publicEntries.length === 0) {
        feedContent.innerHTML = '<div class="no-data"><div class="no-data-icon">âœ¨</div><p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
      } else {
        publicEntries.sort((a, b) => {
          const dateA = a.createdAt ? new Date(a.createdAt) : new Date(a.date || 0);
          const dateB = b.createdAt ? new Date(b.createdAt) : new Date(b.date || 0);
          return dateB - dateA;
        });

        feedContent.innerHTML = publicEntries.map(entry => {
          const content = entry.content || {};
          return `
            <div class="card">
              <div class="card-header">
                <span class="nickname">${escapeHtml(entry.nickname || 'åŒ¿å')}</span>
                <span class="timestamp">${formatDate(entry.createdAt || entry.date)}</span>
              </div>
              <div class="card-content">
                ${content.q1 ? `<div class="question-section"><div class="question-label">ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã ã£ãŸï¼Ÿ</div><div class="answer-text">${escapeHtml(content.q1)}</div></div>` : ''}
                ${content.q2 ? `<div class="question-section"><div class="question-label">ä»Šæ—¥ã®æ°—åˆ†ã¯ï¼Ÿ</div><div class="answer-text">${escapeHtml(content.q2)}</div></div>` : ''}
                ${content.q3 ? `<div class="question-section"><div class="question-label">æ˜æ—¥ã‚„ã‚ŠãŸã„ã“ã¨ã¯ï¼Ÿ</div><div class="answer-text">${escapeHtml(content.q3)}</div></div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      const debugContent = document.getElementById('feedDebugContent');
      debugContent.innerHTML = `
        <div class="debug-line">å–å¾—ä»¶æ•°: ${allEntries.length}</div>
        <div class="debug-line">todayKey: ${todayKeyBase}</div>
        <div class="debug-line">3æ—¥åˆ†ä¸€è‡´ä»¶æ•°: ${publicEntries.length}</div>
        <div class="debug-line">å…ˆé ­3ä»¶: ${publicEntries.slice(0,3).map(e => {
          const ca = e.createdAt ? new Date(e.createdAt) : new Date(e.date || 0);
          const caJST = new Date(ca.getTime() + jstOffset*60000);
          let dk = caJST.toISOString().split('T')[0];
          const h = caJST.getUTCHours();
          if (h < 12) {
            const prev = new Date(caJST.getTime() - 24*60*60*1000);
            dk = prev.toISOString().split('T')[0];
          }
          return `(createdAt: ${e.createdAt}, dateKey: ${dk}, zone: ${e.zone})`;
        }).join(', ')}</div>
      `;
    }

    function renderMyDiaries() {
      const myContent = document.getElementById('myContent');
      const nicknameFilter = document.getElementById('nicknameFilter').value;

      let myEntries = allEntries.filter(entry => {
        return String(entry.userId || '') === String(deviceUserId);
      });

      console.log('[ãƒã‚¤æ—¥è¨˜] deviceUserId:', deviceUserId);
      console.log('[ãƒã‚¤æ—¥è¨˜] activeNickname:', activeNickname);
      console.log('[ãƒã‚¤æ—¥è¨˜] entriesç·æ•°:', allEntries.length);
      console.log('[ãƒã‚¤æ—¥è¨˜] myEntriesï¼ˆçµã‚Šè¾¼ã¿å‰ï¼‰:', myEntries.length);
      if (myEntries.length > 0) {
        console.log('[ãƒã‚¤æ—¥è¨˜] å…ˆé ­1ä»¶:', myEntries[0]);
      }

      if (nicknameFilter) {
        myEntries = myEntries.filter(entry => entry.nickname === nicknameFilter);
      }

      console.log('[ãƒã‚¤æ—¥è¨˜] myEntriesï¼ˆçµã‚Šè¾¼ã¿å¾Œï¼‰:', myEntries.length);

      const myDebugContent = document.getElementById('myDebugContent');
      myDebugContent.innerHTML = `
        <div class="debug-line">deviceUserId: ${deviceUserId}</div>
        <div class="debug-line">entriesç·æ•°: ${allEntries.length}</div>
        <div class="debug-line">myEntriesï¼ˆçµã‚Šè¾¼ã¿å‰ï¼‰: ${allEntries.filter(e => String(e.userId||'')===String(deviceUserId)).length}</div>
        <div class="debug-line">myEntriesï¼ˆçµã‚Šè¾¼ã¿å¾Œï¼‰: ${myEntries.length}</div>
        <div class="debug-line">å…ˆé ­3ä»¶ã®userId: ${myEntries.slice(0,3).map(e => e.userId).join(', ')}</div>
      `;

      // å€™è£œuserIdè‡ªå‹•å¾©å…ƒ
      if (allEntries.length > 0 && myEntries.length === 0) {
        const savedNicknames = JSON.parse(localStorage.getItem('savedNicknames') || '[]');
        const candidateEntries = allEntries.filter(entry => savedNicknames.includes(entry.nickname));
        if (candidateEntries.length > 0) {
          const userIdCount = {};
          candidateEntries.forEach(entry => {
            const uid = entry.userId || '';
            if (uid) {
              userIdCount[uid] = (userIdCount[uid] || 0) + 1;
            }
          });
          let candidateUserId = '';
          let maxCount = 0;
          for (const uid in userIdCount) {
            if (userIdCount[uid] > maxCount) {
              maxCount = userIdCount[uid];
              candidateUserId = uid;
            }
          }
          if (candidateUserId && candidateUserId.startsWith('device_')) {
            myDebugContent.innerHTML += `<div class="debug-line" style="color: orange; font-weight: 600;">å€™è£œuserId: ${candidateUserId} ï¼ˆå¾©å…ƒææ¡ˆï¼šã‚ã‚Šï¼‰</div>`;
            if (confirm('ãƒã‚¤æ—¥è¨˜ãŒè¡¨ç¤ºã•ã‚Œãªã„ãŸã‚ã€éå»ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦ç«¯æœ«IDã‚’å¾©å…ƒã—ã¾ã™ã€‚å¾©å…ƒã™ã‚‹ã¨ãƒã‚¤æ—¥è¨˜ãŒè¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
              localStorage.setItem('deviceUserId', candidateUserId);
              deviceUserId = candidateUserId;
              location.reload();
              return;
            }
          }
        }
      }

      myEntries = myEntries.filter(entry => {
        const diaryId = generateDiaryId(entry);
        return !hiddenDiaryIds.includes(diaryId);
      });

      myEntries.sort((a, b) => {
        const dateA = a.createdAt ? new Date(a.createdAt) : new Date(a.date || 0);
        const dateB = b.createdAt ? new Date(b.createdAt) : new Date(b.date || 0);
        return dateB - dateA;
      });

      if (myEntries.length === 0) {
        myContent.innerHTML = '<div class="no-data"><div class="no-data-icon">ğŸ“”</div><p>ã¾ã æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
      } else {
        myContent.innerHTML = myEntries.map(entry => {
          const diaryId = generateDiaryId(entry);
          let content = entry.content || {};
          if (editedDiaryMap[diaryId]) {
            content = editedDiaryMap[diaryId];
          }
          return `
            <div class="card">
              <div class="card-header">
                <span class="nickname">${escapeHtml(entry.nickname || 'åŒ¿å')}</span>
                <span class="timestamp">${formatDate(entry.createdAt || entry.date)}</span>
              </div>
              <div class="card-content">
                ${content.q1 ? `<div class="question-section"><div class="question-label">ä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã ã£ãŸï¼Ÿ</div><div class="answer-text">${escapeHtml(content.q1)}</div></div>` : ''}
                ${content.q2 ? `<div class="question-section"><div class="question-label">ä»Šæ—¥ã®æ°—åˆ†ã¯ï¼Ÿ</div><div class="answer-text">${escapeHtml(content.q2)}</div></div>` : ''}
                ${content.q3 ? `<div class="question-section"><div class="question-label">æ˜æ—¥ã‚„ã‚ŠãŸã„ã“ã¨ã¯ï¼Ÿ</div><div class="answer-text">${escapeHtml(content.q3)}</div></div>` : ''}
              </div>
              <div class="card-actions">
                <button class="edit-button" onclick="openEditModal('${diaryId}')">âœï¸ ç·¨é›†</button>
                <button class="delete-button" onclick="hideDiary('${diaryId}')">ğŸ—‘ï¸ å‰Šé™¤ï¼ˆè¦‹ãŸç›®ï¼‰</button>
              </div>
            </div>
          `;
        }).join('');
      }

      updateNicknameFilter();
    }

    function generateDiaryId(entry) {
      const createdAt = entry.createdAt || entry.date || '';
      const userId = entry.userId || '';
      const nickname = entry.nickname || '';
      return `${createdAt}|${userId}|${nickname}`;
    }

    function updateNicknameFilter() {
      const nicknameFilter = document.getElementById('nicknameFilter');
      const currentValue = nicknameFilter.value;
      const myEntries = allEntries.filter(entry => String(entry.userId || '') === String(deviceUserId));
      const nicknames = [...new Set(myEntries.map(e => e.nickname))].filter(n => n);
      nicknameFilter.innerHTML = '<option value="">ã™ã¹ã¦</option>' + nicknames.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
      nicknameFilter.value = currentValue;
    }

    function openEditModal(diaryId) {
      currentEditingId = diaryId;
      const entry = allEntries.find(e => generateDiaryId(e) === diaryId);
      if (!entry) return;

      let content = entry.content || {};
      if (editedDiaryMap[diaryId]) {
        content = editedDiaryMap[diaryId];
      }

      document.getElementById('editQ1').value = content.q1 || '';
      document.getElementById('editQ2').value = content.q2 || '';
      document.getElementById('editQ3').value = content.q3 || '';

      document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditingId = null;
    }

    function saveEdit() {
      if (!currentEditingId) return;

      const newContent = {
        q1: document.getElementById('editQ1').value,
        q2: document.getElementById('editQ2').value,
        q3: document.getElementById('editQ3').value
      };

      editedDiaryMap[currentEditingId] = newContent;
      localStorage.setItem('editedDiaryMap', JSON.stringify(editedDiaryMap));

      showMessage('editModalMessage', 'success', 'ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰');
      setTimeout(() => {
        closeEditModal();
        renderMyDiaries();
      }, 1000);
    }

    function hideDiary(diaryId) {
      if (!confirm('ã“ã®æ—¥è¨˜ã‚’è¦‹ãŸç›®ä¸Šå‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚Šã¾ã™ï¼‰')) return;
      hiddenDiaryIds.push(diaryId);
      localStorage.setItem('hiddenDiaryIds', JSON.stringify(hiddenDiaryIds));
      renderMyDiaries();
    }

    function restoreHiddenDiaries() {
      if (hiddenDiaryIds.length === 0) {
        showMessage('restoreMessage', 'info', 'å‰Šé™¤ã•ã‚ŒãŸæ—¥è¨˜ã¯ã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      if (!confirm('è¦‹ãŸç›®å‰Šé™¤ã—ãŸã™ã¹ã¦ã®æ—¥è¨˜ã‚’å…ƒã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
      hiddenDiaryIds = [];
      localStorage.setItem('hiddenDiaryIds', JSON.stringify(hiddenDiaryIds));
      showMessage('restoreMessage', 'success', 'ã™ã¹ã¦ã®æ—¥è¨˜ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
      renderMyDiaries();
    }

    function loadSettings() {
      document.getElementById('nicknameInput').value = activeNickname;
      const savedNicknames = JSON.parse(localStorage.getItem('savedNicknames') || '[]');
      const nicknameList = document.getElementById('nicknameList');
      if (savedNicknames.length === 0) {
        nicknameList.textContent = 'ã¾ã ä¿å­˜ã•ã‚ŒãŸãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“';
      } else {
        nicknameList.innerHTML = savedNicknames.map(n => `<span style="display:inline-block; margin:4px 8px 4px 0; padding:4px 10px; background:#f0f0f0; border-radius:12px;">${escapeHtml(n)}</span>`).join('');
      }
    }

    function saveNickname() {
      const newNickname = document.getElementById('nicknameInput').value.trim();
      if (!newNickname) {
        showMessage('nicknameMessage', 'error', 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      activeNickname = newNickname;
      localStorage.setItem('activeNickname', activeNickname);

      let savedNicknames = JSON.parse(localStorage.getItem('savedNicknames') || '[]');
      if (!savedNicknames.includes(newNickname)) {
        savedNicknames.push(newNickname);
        localStorage.setItem('savedNicknames', JSON.stringify(savedNicknames));
      }

      showMessage('nicknameMessage', 'success', 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      loadSettings();
    }

    function showMessage(elementId, type, message) {
      const el = document.getElementById(elementId);
      if (!message) {
        el.innerHTML = '';
        return;
      }
      el.innerHTML = `<div class="message ${type}">${message}</div>`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'ä¸æ˜';
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      const year = d.getFullYear();
      const month = ('0' + (d.getMonth() + 1)).slice(-2);
      const day = ('0' + d.getDate()).slice(-2);
      const hour = ('0' + d.getHours()).slice(-2);
      const minute = ('0' + d.getMinutes()).slice(-2);
      return `${year}/${month}/${day} ${hour}:${minute}`;
    }

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    window.onclick = function(event) {
      const modal = document.getElementById('editModal');
      if (event.target === modal) {
        closeEditModal();
      }
    };

    loadFeed();
  </script>
</body>
</html>

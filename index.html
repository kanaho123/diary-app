<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»Šæ—¥ã®æ—¥è¨˜ v0.0.27</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    .version-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    .nickname-display {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 8px;
    }
    .tabs {
      display: flex;
      background: #f5f5f5;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      background: transparent;
      font-size: 14px;
      color: #666;
    }
    .tab.active {
      background: white;
      color: #667eea;
      font-weight: bold;
      border-bottom: 3px solid #667eea;
    }
    .tab-content {
      display: none;
      padding: 20px;
      animation: fadeIn 0.3s;
    }
    .tab-content.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-group {
      margin-bottom: 20px;
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .question-label {
      font-weight: 500;
      color: #555;
      font-size: 14px;
    }
    .required-badge, .optional-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 8px;
      font-weight: 500;
    }
    .required-badge {
      background: #ffe0e0;
      color: #d32f2f;
    }
    .optional-badge {
      background: #e3f2fd;
      color: #1976d2;
    }
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: border-color 0.3s;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    .visibility-group {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .visibility-btn {
      flex: 1;
      min-width: 100px;
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
      text-align: center;
    }
    .visibility-btn:hover {
      border-color: #667eea;
    }
    .visibility-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    .btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .btn:active {
      transform: translateY(0);
    }
    .diary-card {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #e0e0e0;
    }
    .diary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    .diary-author {
      font-weight: bold;
      color: #667eea;
      font-size: 15px;
    }
    .diary-date {
      font-size: 12px;
      color: #999;
    }
    .diary-content {
      line-height: 1.6;
    }
    .diary-answer {
      margin-bottom: 12px;
    }
    .diary-question {
      font-weight: 500;
      color: #555;
      margin-bottom: 4px;
      font-size: 13px;
    }
    .diary-answer-text {
      color: #333;
      padding-left: 10px;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .show-more-btn {
      background: #e3f2fd;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      color: #1976d2;
      font-size: 13px;
      margin-top: 10px;
      transition: background 0.3s;
    }
    .show-more-btn:hover {
      background: #bbdefb;
    }
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
      word-break: break-word;
    }
    .message.success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #81c784;
    }
    .message.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef5350;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .edit-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .edit-btn, .cancel-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s;
    }
    .edit-btn {
      background: #fff3e0;
      color: #f57c00;
    }
    .cancel-btn {
      background: #f5f5f5;
      color: #666;
    }
    .edit-note {
      font-size: 11px;
      color: #999;
      margin-top: 5px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="version-badge">v0.0.27</div>
      <h1>ğŸ“” ä»Šæ—¥ã®æ—¥è¨˜ v0.0.27</h1>
      <div class="nickname-display" id="nicknameDisplay"></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="write">æ›¸ã</button>
      <button class="tab" data-tab="feed">ã¿ã‚“ãªã®è¨˜éŒ²</button>
      <button class="tab" data-tab="my">ãƒã‚¤æ—¥è¨˜</button>
      <button class="tab" data-tab="settings">è¨­å®š</button>
    </div>

    <!-- æ›¸ãã‚¿ãƒ– -->
    <div class="tab-content active" id="writeTab">
      <div id="messageBox"></div>
      <div id="questionsContainer"></div>
      <button class="btn" onclick="saveDiary()">ä¿å­˜ã™ã‚‹</button>
    </div>

    <!-- ã¿ã‚“ãªã®è¨˜éŒ²ã‚¿ãƒ– -->
    <div class="tab-content" id="feedTab">
      <div id="feedContent"></div>
    </div>

    <!-- ãƒã‚¤æ—¥è¨˜ã‚¿ãƒ– -->
    <div class="tab-content" id="myTab">
      <div id="myDiaryContent"></div>
    </div>

    <!-- è¨­å®šã‚¿ãƒ– -->
    <div class="tab-content" id="settingsTab">
      <div style="padding: 20px;">
        <h3 style="color: #667eea; margin-bottom: 15px;">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¨­å®š</h3>
        <input type="text" id="nicknameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›" 
               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; margin-bottom: 10px;">
        <button class="btn" onclick="saveNickname()">ä¿å­˜</button>
        
        <div style="margin-top: 30px;">
          <h4 style="color: #667eea; margin-bottom: 10px;">æ›´æ–°å±¥æ­´</h4>
          <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-size: 13px; line-height: 1.8;">
            <div>(2026-01-18) v0.0.27 Sheetsä¿å­˜ã«çµ±ä¸€ãƒ»è¡¨ç¤ºæ•´å½¢ãƒ»é€ä¿¡çµæœè¡¨ç¤º</div>
          </div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; font-size: 12px;">
          <strong>ç·¨é›†æ©Ÿèƒ½ã«ã¤ã„ã¦</strong><br>
          ç¾åœ¨ã€Apps Scriptã«æ›´æ–°APIãŒãªã„ãŸã‚ã€ç·¨é›†ã¯ã€Œãƒ­ãƒ¼ã‚«ãƒ«ä¸‹æ›¸ãã€ã¨ã—ã¦ä¸€æ™‚ä¿å­˜ã•ã‚Œã¾ã™ã€‚ç·¨é›†å¾Œã«ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€æ–°ã—ã„æŠ•ç¨¿ã¨ã—ã¦å†é€ä¿¡ã•ã‚Œã¾ã™ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    // <!--
    // Changelog:
    // (2026-01-18) v0.0.27 Sheetsä¿å­˜ã«çµ±ä¸€ãƒ»è¡¨ç¤ºæ•´å½¢ãƒ»é€ä¿¡çµæœè¡¨ç¤º
    // -->
    
    const APP_VERSION = '0.0.27';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwHN2pvh7y1i5cEEHIWrUP_o6cMnDRCGdfurK0xrw3cVEElKtAepEDZ510JnbDdY3BI/exec';
    
    let userName = localStorage.getItem('userName') || '';
    let allEntries = [];
    let editingEntry = null;

    // è³ªå•å®šç¾©
    const questions = [
      { id: 'q1', label: 'ä»Šæ—¥ã®æ°—åˆ†ã¯ï¼Ÿ', required: true },
      { id: 'q2', label: 'å¬‰ã—ã‹ã£ãŸã“ã¨', required: true },
      { id: 'q3', label: 'ä»Šæ—¥ã®è‡ªåˆ†è¤’ã‚ã‚‹', required: true },
      { id: 'q4', label: 'æ„Ÿè¬ã—ãŸã„ã“ã¨ï¼ˆäººã§ã‚‚ç‰©ã§ã‚‚ï¼‰', required: false },
      { id: 'q5', label: 'ã‚„ã‚‰ã‹ã—ãŸã“ã¨', required: false },
      { id: 'q6', label: 'ã¡ã‚‡ã£ã¨å¿ƒã«æ®‹ã£ãŸã“ã¨', required: false },
      { id: 'q7', label: 'æ®‹ã—ãŸã„ã“ã¨', required: false },
      { id: 'q8', label: 'æ˜æ—¥ã®è‡ªåˆ†ã¸', required: false }
    ];

    // åˆæœŸåŒ–
    function init() {
      updateNicknameDisplay();
      setupTabs();
      renderQuestions();
      loadFeed();
      loadMyDiary();
      document.getElementById('nicknameInput').value = userName;
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(targetTab + 'Tab').classList.add('active');
          
          if (targetTab === 'feed') {
            loadFeed();
          } else if (targetTab === 'my') {
            loadMyDiary();
          }
        });
      });
    }

    // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è¡¨ç¤ºæ›´æ–°
    function updateNicknameDisplay() {
      const display = document.getElementById('nicknameDisplay');
      if (userName) {
        display.textContent = `ã“ã‚“ã«ã¡ã¯ã€${userName}ã•ã‚“`;
      } else {
        display.textContent = 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ãã ã•ã„';
      }
    }

    // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ä¿å­˜
    function saveNickname() {
      const input = document.getElementById('nicknameInput');
      const newName = input.value.trim();
      if (!newName) {
        alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      userName = newName;
      localStorage.setItem('userName', userName);
      updateNicknameDisplay();
      showMessage('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    }

    // è³ªå•ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderQuestions(answersData = null) {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';
      
      questions.forEach(q => {
        const formGroup = document.createElement('div');
        formGroup.className = 'form-group';
        
        const header = document.createElement('div');
        header.className = 'question-header';
        
        const label = document.createElement('div');
        label.className = 'question-label';
        label.textContent = q.label;
        
        const badge = document.createElement('span');
        badge.className = q.required ? 'required-badge' : 'optional-badge';
        badge.textContent = q.required ? 'å¿…é ˆ' : 'ä»»æ„';
        
        header.appendChild(label);
        header.appendChild(badge);
        formGroup.appendChild(header);
        
        const textarea = document.createElement('textarea');
        textarea.id = q.id;
        textarea.placeholder = q.required ? 'å…¥åŠ›ã—ã¦ãã ã•ã„' : 'ä»»æ„';
        if (answersData) {
          const answer = answersData.find(a => a.id === q.id);
          if (answer) textarea.value = answer.value || '';
        }
        formGroup.appendChild(textarea);
        
        const visibilityGroup = document.createElement('div');
        visibilityGroup.className = 'visibility-group';
        
        const visibilityOptions = [
          { value: 'private', label: 'ğŸ”’ è‡ªåˆ†ç”¨' },
          { value: 'anonymous', label: 'ğŸ‘¤ åŒ¿åå…¬é–‹' },
          { value: 'public', label: 'ğŸŒ å…¨ä½“å…¬é–‹' },
          { value: 'friends', label: 'ğŸ‘¥ å‹é”ã®ã¿' }
        ];
        
        visibilityOptions.forEach(opt => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'visibility-btn';
          btn.dataset.question = q.id;
          btn.dataset.visibility = opt.value;
          btn.textContent = opt.label;
          
          if (answersData) {
            const answer = answersData.find(a => a.id === q.id);
            if (answer && answer.visibility === opt.value) {
              btn.classList.add('active');
            }
          } else if (opt.value === 'public') {
            btn.classList.add('active');
          }
          
          btn.addEventListener('click', function() {
            document.querySelectorAll(`.visibility-btn[data-question="${q.id}"]`)
              .forEach(b => b.classList.remove('active'));
            this.classList.add('active');
          });
          
          visibilityGroup.appendChild(btn);
        });
        
        formGroup.appendChild(visibilityGroup);
        container.appendChild(formGroup);
      });
    }

    // æ—¥è¨˜ä¿å­˜
    async function saveDiary() {
      if (!userName) {
        showMessage('å…ˆã«ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const answers = [];
      let hasRequiredEmpty = false;
      
      questions.forEach(q => {
        const textarea = document.getElementById(q.id);
        const value = textarea ? textarea.value.trim() : '';
        
        if (q.required && !value) {
          hasRequiredEmpty = true;
        }
        
        const activeBtn = document.querySelector(`.visibility-btn[data-question="${q.id}"].active`);
        const visibility = activeBtn ? activeBtn.dataset.visibility : 'public';
        
        answers.push({
          id: q.id,
          label: q.label,
          value: value,
          visibility: visibility
        });
      });
      
      if (hasRequiredEmpty) {
        showMessage('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      const payload = {
        userName: userName,
        zone: 'public',
        visibility: 'public',
        dateISO: new Date().toISOString(),
        answers: answers
      };
      
      console.log('POST payload', payload);
      
      try {
        const params = new URLSearchParams();
        params.set('action', 'add');
        params.set('payload', JSON.stringify(payload));
        
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          body: params
        });
        
        const result = await response.json();
        console.log('POST result', result);
        
        if (result.success || result.result === 'ok') {
          showMessage('é€ä¿¡æˆåŠŸã—ã¾ã—ãŸï¼', 'success');
          questions.forEach(q => {
            const textarea = document.getElementById(q.id);
            if (textarea) textarea.value = '';
          });
          renderQuestions();
          loadFeed();
          loadMyDiary();
        } else {
          throw new Error(result.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('Save error:', error);
        showMessage('é€ä¿¡ã§ãã¦ã„ã¾ã›ã‚“: ' + error.message, 'error');
      }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿
    async function loadFeed() {
      try {
        const url = `${APPS_SCRIPT_URL}?action=list`;
        console.log('Fetching from:', url);
        
        const response = await fetch(url);
        const text = await response.text();
        console.log('Raw response:', text.substring(0, 500));
        
        const data = JSON.parse(text);
        console.log('Parsed data:', data);
        
        if (!data || !Array.isArray(data.entries)) {
          throw new Error('Invalid data format');
        }
        
        allEntries = data.entries.map(entry => ({
          ...entry,
          answers: parseAnswers(entry.answers)
        }));
        
        console.log('Total entries:', allEntries.length);
        renderFeed();
      } catch (error) {
        console.error('Load feed error:', error);
        document.getElementById('feedContent').innerHTML = 
          `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p></div>`;
      }
    }

    // answersã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆæ–‡å­—åˆ—/ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸¡å¯¾å¿œï¼‰
    function parseAnswers(answers) {
      if (typeof answers === 'string') {
        try {
          return JSON.parse(answers);
        } catch (e) {
          console.warn('Failed to parse answers:', answers);
          return [];
        }
      } else if (Array.isArray(answers)) {
        return answers;
      } else {
        return [];
      }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ‰è¡¨ç¤º
    function renderFeed() {
      const container = document.getElementById('feedContent');
      
      const publicEntries = allEntries.filter(e => 
        e.visibility === 'public' || e.zone === 'public'
      );
      
      publicEntries.sort((a, b) => {
        const dateA = new Date(a.dateISO || a.createdAt || a.date);
        const dateB = new Date(b.dateISO || b.createdAt || b.date);
        return dateB - dateA;
      });
      
      if (publicEntries.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }
      
      container.innerHTML = '';
      publicEntries.forEach(entry => {
        const card = createDiaryCard(entry, false);
        container.appendChild(card);
      });
    }

    // ãƒã‚¤æ—¥è¨˜èª­ã¿è¾¼ã¿
    async function loadMyDiary() {
      if (allEntries.length === 0) {
        await loadFeed();
      }
      renderMyDiary();
    }

    // ãƒã‚¤æ—¥è¨˜è¡¨ç¤º
    function renderMyDiary() {
      const container = document.getElementById('myDiaryContent');
      
      if (!userName) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>å…ˆã«ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ãã ã•ã„</p></div>';
        return;
      }
      
      const myEntries = allEntries.filter(e => e.userName === userName);
      
      myEntries.sort((a, b) => {
        const dateA = new Date(a.dateISO || a.createdAt || a.date);
        const dateB = new Date(b.dateISO || b.createdAt || b.date);
        return dateB - dateA;
      });
      
      if (myEntries.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>ã¾ã æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }
      
      container.innerHTML = '';
      myEntries.forEach(entry => {
        const card = createDiaryCard(entry, true);
        container.appendChild(card);
      });
    }

    // æ—¥è¨˜ã‚«ãƒ¼ãƒ‰ä½œæˆ
    function createDiaryCard(entry, isMyDiary) {
      const card = document.createElement('div');
      card.className = 'diary-card';
      
      const header = document.createElement('div');
      header.className = 'diary-header';
      
      const author = document.createElement('div');
      author.className = 'diary-author';
      author.textContent = entry.userName || 'åŒ¿å';
      
      const date = document.createElement('div');
      date.className = 'diary-date';
      const dateObj = new Date(entry.dateISO || entry.createdAt || entry.date);
      date.textContent = dateObj.toLocaleDateString('ja-JP');
      
      header.appendChild(author);
      header.appendChild(date);
      card.appendChild(header);
      
      const content = document.createElement('div');
      content.className = 'diary-content';
      
      const answers = entry.answers || [];
      const nonEmptyAnswers = answers.filter(a => a.value && a.value.trim());
      
      if (nonEmptyAnswers.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.textContent = 'ï¼ˆå†…å®¹ãªã—ï¼‰';
        emptyDiv.style.color = '#999';
        content.appendChild(emptyDiv);
      } else {
        const displayCount = Math.min(3, nonEmptyAnswers.length);
        
        for (let i = 0; i < displayCount; i++) {
          const answer = nonEmptyAnswers[i];
          const answerDiv = document.createElement('div');
          answerDiv.className = 'diary-answer';
          
          const questionLabel = document.createElement('div');
          questionLabel.className = 'diary-question';
          questionLabel.textContent = answer.label || 'è³ªå•';
          
          const answerText = document.createElement('div');
          answerText.className = 'diary-answer-text';
          answerText.textContent = answer.value || '';
          
          answerDiv.appendChild(questionLabel);
          answerDiv.appendChild(answerText);
          content.appendChild(answerDiv);
        }
        
        if (nonEmptyAnswers.length > 3) {
          const showMoreBtn = document.createElement('button');
          showMoreBtn.className = 'show-more-btn';
          showMoreBtn.textContent = 'ç¶šãã‚’èª­ã‚€';
          showMoreBtn.onclick = () => {
            for (let i = displayCount; i < nonEmptyAnswers.length; i++) {
              const answer = nonEmptyAnswers[i];
              const answerDiv = document.createElement('div');
              answerDiv.className = 'diary-answer';
              
              const questionLabel = document.createElement('div');
              questionLabel.className = 'diary-question';
              questionLabel.textContent = answer.label || 'è³ªå•';
              
              const answerText = document.createElement('div');
              answerText.className = 'diary-answer-text';
              answerText.textContent = answer.value || '';
              
              answerDiv.appendChild(questionLabel);
              answerDiv.appendChild(answerText);
              content.appendChild(answerDiv);
            }
            showMoreBtn.remove();
          };
          content.appendChild(showMoreBtn);
        }
      }
      
      card.appendChild(content);
      
      if (isMyDiary) {
        const actions = document.createElement('div');
        actions.className = 'edit-actions';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.textContent = 'âœï¸ ç·¨é›†';
        editBtn.onclick = () => editDiary(entry);
        
        actions.appendChild(editBtn);
        card.appendChild(actions);
        
        const note = document.createElement('div');
        note.className = 'edit-note';
        note.textContent = 'â€»ç·¨é›†å¾Œã¯æ–°ã—ã„æŠ•ç¨¿ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™';
        card.appendChild(note);
      }
      
      return card;
    }

    // æ—¥è¨˜ç·¨é›†
    function editDiary(entry) {
      editingEntry = entry;
      renderQuestions(entry.answers);
      document.querySelectorAll('.tab')[0].click();
      showMessage('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚å¤‰æ›´å¾Œã«ã€Œä¿å­˜ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„', 'success');
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(text, type) {
      const messageBox = document.getElementById('messageBox');
      messageBox.innerHTML = `<div class="message ${type}">${text}</div>`;
      setTimeout(() => {
        messageBox.innerHTML = '';
      }, 5000);
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
